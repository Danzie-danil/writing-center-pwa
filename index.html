<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Writing Center - Daniel Idrissa Ramadhan</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional CV and Cover Letter Builder by Daniel Idrissa Ramadhan">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Writing Center">
    <link rel="manifest" href="/writing-center-pwa/manifest.json">
    
    <!-- Favicon and Apple Touch Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/writing-center-pwa/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/writing-center-pwa/icons/icon-192x192.png">
    <style>
        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        /* Page Section Management - CRITICAL */
        .page-section {
            display: none !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .page-section.active {
            display: block !important;
            position: relative;
            opacity: 1;
            visibility: visible;
        }

        /* Back Button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Brand Badge on Tool Pages */
        .brand-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid #9ca3af;
        }

        .brand-badge::before {
            content: 'âœ¨ ';
        }

        /* CV Header Buttons Container - MINIMAL DESIGN */
        #cvPage .cv-header-buttons {
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin: 20px;
            border-radius: 8px;
        }

        #cvPage .cv-back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        #cvPage .cv-back-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #cvPage .cv-print-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        #cvPage .cv-print-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.4);
        }

        /* ==================== LANDING PAGE STYLES ==================== */
        #landingPage {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'Bookman Old Style', 'Book Antiqua', Georgia, serif;
        }

        #landingPage.active {
            display: flex !important;
        }

        #landingPage .landing-container {
            max-width: 1000px;
            width: 100%;
        }

        #landingPage .landing-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        #landingPage .brand-name {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
            opacity: 0.95;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #landingPage .landing-header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        #landingPage .landing-header p {
            font-size: 20px;
            opacity: 0.95;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #landingPage .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 40px;
            padding: 20px;
        }

        #landingPage .card {
            background: white;
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease forwards;
        }

        #landingPage .card:nth-child(1) {
            animation-delay: 0.1s;
            opacity: 0;
        }

        #landingPage .card:nth-child(2) {
            animation-delay: 0.2s;
            opacity: 0;
        }

        #landingPage .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        #landingPage .card:hover {
            transform: translateY(-15px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
        }

        #landingPage .card:hover::before {
            transform: scaleX(1);
        }

        #landingPage .card-icon {
            font-size: 80px;
            margin-bottom: 25px;
            display: inline-block;
            transition: transform 0.4s ease;
        }

        #landingPage .card:hover .card-icon {
            transform: scale(1.2) rotate(5deg);
        }

        #landingPage .card h2 {
            font-size: 32px;
            color: #1a202c;
            margin-bottom: 15px;
            font-weight: 700;
        }

        #landingPage .card p {
            font-size: 16px;
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        #landingPage .card-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        #landingPage .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        #landingPage .landing-footer {
            text-align: center;
            margin-top: 50px;
            color: white;
        }

        #landingPage .landing-footer p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        #landingPage .landing-footer .creator {
            font-size: 16px;
            font-weight: 600;
            opacity: 1;
            letter-spacing: 0.5px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            #landingPage .brand-name {
                font-size: 18px;
            }

            #landingPage .landing-header h1 {
                font-size: 36px;
            }

            #landingPage .landing-header p {
                font-size: 16px;
            }

            #landingPage .cards-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            #landingPage .card {
                padding: 40px 30px;
            }

            #landingPage .card h2 {
                font-size: 26px;
            }

            .brand-badge {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px 15px;
            }

            #cvPage .cv-header-buttons {
                padding: 10px 15px;
                margin: 15px;
            }

            #cvPage .cv-back-btn,
            #cvPage .cv-print-btn {
                padding: 7px 14px;
                font-size: 12px;
            }
        }

        /* ==================== LETTER WRITER STYLES ==================== */
#letterPage 
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }#letterPage 

        body {
            font-family: 'Bookman Old Style', 'Times New Roman', serif;
            background-color: #f5f5f5;
            padding: 20px;
        }#letterPage 

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }#letterPage 

        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 30px;
            align-items: start;
        }#letterPage 

        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }#letterPage 

        .form-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }#letterPage 

        .form-section h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }#letterPage 

        .form-group {
            margin-bottom: 15px;
        }#letterPage 

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }#letterPage 

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }#letterPage 

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }#letterPage 

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }#letterPage 

        .letter-preview-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }#letterPage 

        .preview-label {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            display: inline-block;
        }#letterPage 

        /* A4 Page Simulation */
        .letter-preview {
            background-color: white;
            width: 210mm;
            min-height: 297mm;
            max-height: 297mm;
            padding: 15mm 20mm 15mm 30mm;
            /* Wider left margin for filing */
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            font-size: 11pt;
            line-height: 1.6;
        }#letterPage 

        .passport-photo {
            position: absolute;
            top: 15mm;
            left: 30mm;
            width: 35mm;
            height: 45mm;
            border: 1px solid #333;
            object-fit: cover;
            z-index: 10;
        }#letterPage 

        .sender-address {
            text-align: right;
            font-size: 10pt;
            margin-bottom: 20px;
            margin-top: 10px;
        }#letterPage 

        .receiver-address {
            text-align: left;
            font-size: 10pt;
            margin-bottom: 20px;
        }#letterPage 

        .through-address {
            text-align: left;
            font-size: 10pt;
            margin-bottom: 20px;
            margin-top: 15px;
        }#letterPage 

        .address-line {
            margin-bottom: 2px;
        }#letterPage 

        .salutation {
            text-decoration: underline;
            margin-bottom: 15px;
            margin-top: 15px;
            font-weight: bold;
            font-size: 11pt;
        }#letterPage 

        .letter-ref-header {
            text-align: center;
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 15px;
            margin-top: 15px;
            font-size: 11pt;
        }#letterPage 

        .letter-body {
            text-align: justify;
            margin-bottom: 20px;
            font-size: 11pt;
        }#letterPage 

        .letter-body p {
            margin-bottom: 10px;
        }#letterPage 

        .indented {
            text-indent: 40px;
        }#letterPage 

        .valediction {
            margin-bottom: 50px;
            text-align: center;
            font-style: italic;
            font-size: 11pt;
        }#letterPage 

        .signature-section {
            margin-top: 15px;
            text-align: center;
        }#letterPage 

        .signature-image {
            max-width: 200px;
            max-height: 60px;
            display: block;
            margin: 0 auto 10px;
        }#letterPage 

        .signature-line {
            border-top: 1px solid #000;
            width: 250px;
            margin: 40px auto 0;
            padding-top: 5px;
            text-align: center;
            font-size: 10pt;
        }#letterPage 

        .signature-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
            margin: 0 auto;
        }#letterPage 

        .signature-contact {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
            margin: 3px auto 0;
            font-size: 9pt;
        }#letterPage 

        .custom-detail-item {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }#letterPage 

        .custom-detail-item input {
            flex: 1;
        }#letterPage 

        .custom-detail-item button {
            padding: 8px 12px;
            min-width: 40px;
        }#letterPage 

        .toolbar {
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }#letterPage 

        .toolbar button {
            padding: 5px 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: #000;
            font-weight: bold;
        }#letterPage 

        .toolbar button:hover {
            background-color: #e0e0e0;
        }#letterPage 

        .toolbar button.active {
            background-color: #4CAF50;
            color: white;
        }#letterPage 

        .toolbar input[type="color"],
        .toolbar input[type="number"] {
            width: auto;
            padding: 2px 5px;
        }#letterPage 

        button {
            padding: 10px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }#letterPage 

        button:hover {
            background-color: #45a049;
        }#letterPage 

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }#letterPage 

        .export-btn {
            background-color: #2196F3;
        }#letterPage 

        .export-btn:hover {
            background-color: #0b7dda;
        }#letterPage 

        .secondary-btn {
            background-color: #666;
        }#letterPage 

        .secondary-btn:hover {
            background-color: #555;
        }#letterPage 

        textarea {
            resize: vertical;
            min-height: 80px;
        }#letterPage 

        .file-upload-btn {
            display: inline-block;
            padding: 8px 12px;
            background-color: #FF9800;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }#letterPage 

        .file-upload-btn:hover {
            background-color: #F57C00;
        }#letterPage 

        .file-upload-btn input[type="file"] {
            display: none;
        }#letterPage 

        canvas {
            border: 1px solid #ddd;
            cursor: crosshair;
            display: block;
            margin-top: 10px;
        }#letterPage 

        .button-group {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }#letterPage 

        .print-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #9C27B0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }#letterPage 

        .print-btn:hover {
            background-color: #7B1FA2;
        }#letterPage 

        @media print {

            .form-section,
            .print-btn,
            .export-buttons,
            button,
            .preview-label,
            h1 {
                display: none !important;
            }#letterPage 
            
            .letter-preview-container {
                background-color: white;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
            }#letterPage 

            body {
                background-color: white;
                padding: 0;
                counter-reset: page;
            }#letterPage 

            .main-content {
                display: block;
            }#letterPage 

            .letter-preview {
                border: none;
                box-shadow: none;
                margin: 0;
                page-break-after: avoid;
                position: relative;
            }#letterPage 

            /* Page numbers at bottom right */
            .letter-preview::after {
                content: counter(page);
                counter-increment: page;
                position: fixed;
                bottom: 10mm;
                right: 20mm;
                font-size: 10pt;
                color: #333;
            }#letterPage 

            @page {
                size: A4;
                margin: 0;
            }
        }#letterPage 

        .section-divider {
            border-top: 1px solid #ddd;
            margin: 20px 0 15px;
        }
    

        /* ==================== CV BUILDER STYLES ==================== */
#cvPage 
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }#cvPage 

        body {
            font-family: 'Bookman Old Style', 'Book Antiqua', Georgia, serif;
            background: #808080;
            padding: 20px;
            min-height: 100vh;
        }#cvPage 

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 25px;
        }#cvPage 

        .form-section {
            background: rgba(255, 255, 255, 0.98);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }#cvPage 

        .form-section::-webkit-scrollbar {
            width: 8px;
        }#cvPage 

        .form-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }#cvPage 

        .form-section::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }#cvPage 

        .cv-preview {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            padding: 50px;
        }#cvPage 

        .cv-preview::-webkit-scrollbar {
            width: 8px;
        }#cvPage 

        .cv-preview::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }#cvPage 

        .cv-preview::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #1a1a1a, #4a5568);
            border-radius: 10px;
        }#cvPage 

        h2 {
            color: #1a202c;
            margin-bottom: 25px;
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }#cvPage .section-title {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #6b7280;

            font-weight: 700;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #9ca3af;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }#cvPage 

        .section-controls {
            display: flex;
            gap: 5px;
        }#cvPage 

        .move-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            padding: 5px 10px;
            font-size: 11px;
            margin: 0;
            cursor: pointer;
        }#cvPage 

        .form-group {
            margin-bottom: 18px;
        }#cvPage 

        label {
            display: block;
            margin-bottom: 6px;
            color: #2d3748;
            font-weight: 600;
            font-size: 13px;
        }#cvPage 

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Bookman Old Style', 'Book Antiqua', Georgia, serif;
            transition: all 0.3s;
        }#cvPage 

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }#cvPage 

        textarea {
            resize: vertical;
            min-height: 90px;
        }#cvPage 

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 13px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-right: 10px;
            margin-top: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }#cvPage 

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }#cvPage 

        .add-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }#cvPage 

        .add-btn:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
        }#cvPage 

        .entry {
            background: #f7fafc;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid #e2e8f0;
        }#cvPage 

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #cbd5e0;
        }#cvPage 

        .entry-title {
            font-weight: 700;
            color: #2d3748;
            font-size: 14px;
        }#cvPage 

        .visibility-control {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4a5568;
        }#cvPage 

        .visibility-control input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }#cvPage 

        .cv-duties-section {
            margin-top: 15px;
        }#cvPage 

        .cv-duties-label {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 13px;
        }#cvPage 

        .cv-duties-content {
            padding-left: 20px;
        }#cvPage 

        .cv-referee-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }#cvPage 

        .cv-referee-item:last-child {
            margin-bottom: 0;
        }#cvPage 

        .cv-referee-name {
            font-weight: 700;
            font-size: 14px;
            color: #1a202c;
            margin-bottom: 5px;
        }#cvPage 

        .cv-referee-detail {
            margin-bottom: 3px;
            font-size: 13px;
            color: #2d3748;
        }#cvPage 

        .cv-referee-detail strong {
            font-weight: 600;
            min-width: 80px;
            display: inline-block;
        }#cvPage 

        .cv-custom2-item {
            margin-bottom: 15px;
        }#cvPage 

        .cv-custom2-item:last-child {
            margin-bottom: 0;
        }#cvPage 

        .cv-custom2-title {
            font-weight: 700;
            font-size: 14px;
            color: #1a202c;
            margin-bottom: 5px;
        }#cvPage 

        .cv-custom2-description {
            font-size: 13px;
            color: #2d3748;
            padding-left: 15px;
        }#cvPage 

        .custom-detail-entry {
            background: #fff5e6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #ffd699;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }#cvPage 

        .remove-btn {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            padding: 8px 16px;
            font-size: 13px;
            margin-top: 8px;
        }#cvPage 

        .mini-remove-btn {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            padding: 12px 16px;
            font-size: 12px;
            margin-top: 0;
            height: fit-content;
        }#cvPage 

        .custom-section-container {
            background: #e6f7ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #91d5ff;
        }#cvPage 

        .custom-section-title-input {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }#cvPage 

        /* CV OUTPUT STYLES - TABLE LAYOUT WITH STACKED ENTRIES */
        .cv-document {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            position: relative;
            min-height: 297mm;
            padding: 5mm;
        }#cvPage 

        /* Watermark */
        .cv-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.03);
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 8px;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }#cvPage 

        .cv-content-wrapper {
            position: relative;
            z-index: 1;
        }#cvPage 

        .cv-main-title {
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            padding: 15px 25px;
            border-bottom: 3px solid #000;
            page-break-after: avoid;
            break-after: avoid;
        }#cvPage 

        .cv-header-section {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            padding: 25px;
            border-bottom: 3px solid #000;
            margin-bottom: 20px;
            page-break-inside: avoid;
            break-inside: avoid;
            page-break-after: avoid;
            break-after: avoid;
        }#cvPage 

        .cv-header-section.no-photo {
            grid-template-columns: 1fr;
        }#cvPage 

        .cv-photo-container {
            width: 140px;
            height: 168px;
            border: 3px solid #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }#cvPage 

        .cv-photo-container.hidden {
            display: none;
        }#cvPage 

        .cv-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }#cvPage 

        .photo-placeholder {
            color: #cbd5e0;
            font-size: 48px;
            user-select: none;
        }#cvPage 

        .cv-contact-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }#cvPage 

        .cv-name {
            font-size: 32px;
            font-weight: 800;
            color: #000;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            text-transform: capitalize;
        }#cvPage 

        .cv-title-line {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: capitalize;
        }#cvPage 

        /* Personal Details Table */
        .cv-personal-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }#cvPage 

        .cv-personal-details-table tr {
            border-bottom: 1px solid #e0e0e0;
        }#cvPage 

        .cv-personal-details-table tr:last-child {
            border-bottom: none;
        }#cvPage 

        .cv-personal-details-table td {
            padding: 6px 8px;
            font-size: 13px;
            vertical-align: top;
        }#cvPage 

        .cv-personal-details-table td:first-child {
            font-weight: 800;
            color: #000;
            width: 140px;
            text-transform: uppercase;
        }#cvPage 

        .cv-personal-details-table td:last-child {
            color: #000;
        }#cvPage 

        /* Section Headers with Shaded Background */
        .cv-section {
            margin-bottom: 20px;
            padding: 0 25px;
        }#cvPage 

        .cv-section-header-box {
            background: #6b7280;
            color: white;
            padding: 8px 15px;
            margin-bottom: 15px;
            font-size: 15px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            page-break-after: avoid;
            break-after: avoid;
        }#cvPage 

        /* Unified Content Table - All entries in one table */
        .cv-unified-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            margin-bottom: 15px;
            page-break-inside: auto;
        }#cvPage 

        .cv-unified-table thead {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            page-break-inside: avoid;
            break-inside: avoid;
            page-break-after: avoid;
            break-after: avoid;
            display: table-header-group;
        }#cvPage 

        .cv-unified-table th {
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 800;
            color: #000;
            text-align: left;
            border-bottom: 2px solid #000;
            border-right: 2px solid #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }#cvPage 

        .cv-unified-table th:last-child {
            border-right: none;
        }#cvPage 

        .cv-unified-table tbody tr {
            page-break-inside: avoid;
            break-inside: avoid;
        }#cvPage 

        .cv-unified-table tr {
            border-bottom: 2px solid #999;
        }#cvPage 

        .cv-unified-table tbody tr:last-child {
            border-bottom: none;
        }#cvPage 

        .cv-unified-table td {
            padding: 10px 12px;
            font-size: 13px;
            vertical-align: top;
            border-right: 2px solid #ddd;
            color: #000;
            line-height: 1.6;
            orphans: 2;
            widows: 2;
        }#cvPage 

        .cv-unified-table td:last-child {
            border-right: none;
        }#cvPage 

        /* Dynamic text case styles */
        .cv-document.text-uppercase td,
        .cv-document.text-uppercase .cv-name,
        .cv-document.text-uppercase .cv-title-line,
        .cv-document.text-uppercase .cv-personal-details-table td:last-child,
        .cv-document.text-uppercase .cv-declaration-text {
            text-transform: uppercase !important;
        }#cvPage 

        .cv-document.text-lowercase td,
        .cv-document.text-lowercase .cv-name,
        .cv-document.text-lowercase .cv-title-line,
        .cv-document.text-lowercase .cv-personal-details-table td:last-child,
        .cv-document.text-lowercase .cv-declaration-text {
            text-transform: lowercase !important;
        }#cvPage 

        .cv-document.text-capitalize td,
        .cv-document.text-capitalize .cv-name,
        .cv-document.text-capitalize .cv-title-line,
        .cv-document.text-capitalize .cv-personal-details-table td:last-child,
        .cv-document.text-capitalize .cv-declaration-text {
            text-transform: capitalize !important;
        }#cvPage 

        .cv-document.text-none td,
        .cv-document.text-none .cv-name,
        .cv-document.text-none .cv-title-line,
        .cv-document.text-none .cv-personal-details-table td:last-child,
        .cv-document.text-none .cv-declaration-text {
            text-transform: none !important;
        }#cvPage 

        .cv-table-header {
            font-weight: 700;
            color: #000;
            width: 140px;
            background: #f5f5f5;
        }#cvPage 

        .cv-table-content {
            color: #2d3748;
            line-height: 1.6;
        }#cvPage 

        .cv-item-title {
            font-size: 14px;
            font-weight: 700;
            color: #000;
            margin-bottom: 2px;
        }#cvPage 

        .cv-item-subtitle {
            font-size: 12px;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 2px;
        }#cvPage 

        .cv-item-date {
            font-size: 11px;
            color: #718096;
            font-style: italic;
            margin-bottom: 4px;
        }#cvPage 

        .cv-item-description {
            font-size: 12px;
            color: #2d3748;
            line-height: 1.6;
            margin-top: 4px;
        }#cvPage 

        .cv-item-description ul {
            margin-left: 18px;
            margin-top: 3px;
        }#cvPage 

        .cv-item-description li {
            margin-bottom: 2px;
        }#cvPage 

        /* Skills Table */
        .cv-skills-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            page-break-inside: avoid;
            break-inside: avoid;
        }#cvPage 

        .cv-skills-table td {
            padding: 12px;
        }#cvPage 

        .cv-skills-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }#cvPage 

        .cv-skill-item {
            background: #6b7280;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }#cvPage 

        .cv-summary-text {
            font-size: 13px;
            color: #000;
            line-height: 1.7;
            text-align: justify;
        }#cvPage 

        /* Declaration Section */
        .cv-declaration-text {
            font-size: 13px;
            color: #000;
            line-height: 1.7;
            text-align: justify;
            margin-bottom: 20px;
        }#cvPage 

        /* Signature Section */
        .cv-signature-container {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            page-break-inside: avoid;
            break-inside: avoid;
        }#cvPage 

        .cv-signature-label {
            font-size: 13px;
            font-weight: 700;
            color: #000;
            text-transform: uppercase;
            margin-bottom: 10px;
        }#cvPage 

        .cv-signature-line {
            display: inline-block;
            width: 300px;
            border-bottom: 2px solid #000;
            margin: 0 auto;
        }#cvPage 

        @media print {
            body {
                background: white;
                padding: 0;
            }#cvPage 
            .form-section {
                display: none !important;
            }#cvPage 
            .container {
                display: block;
                max-width: 100%;
            }#cvPage 
            .cv-preview {
                box-shadow: none;
                border-radius: 0;
                max-height: none;
                padding: 0;
            }#cvPage 
            .cv-document {
                margin: 0;
                box-shadow: none;
                padding: 5mm;
            }#cvPage 
            .cv-unified-table tbody tr {
                page-break-inside: avoid;
                break-inside: avoid;
            }#cvPage 
            .cv-unified-table thead {
                display: table-header-group;
            }#cvPage 
            button {
                display: none !important;
            }#cvPage 
            .cv-watermark {
                position: absolute;
            }
        }#cvPage 

        @page {
            size: A4;
            margin: 0.2in;
        }
    

        /* ==================== PRINT STYLES ==================== */
        @media print {
            /* Hide branding and buttons when printing */
            .brand-badge,
            .cv-header-buttons {
                display: none !important;
            }

            /* Reset everything */
            html, body {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
                background: white;
            }

            /* Always hide these elements */
            .back-button,
            #landingPage,
            button,
            .export-buttons,
            .print-btn,
            .preview-label {
                display: none !important;
            }

            /* Hide inactive pages */
            .page-section:not(.active) {
                display: none !important;
            }

            /* ===== LETTER PAGE PRINT STYLES ===== */
            #letterPage.active {
                width: 100%;
                height: auto;
                overflow: visible;
                position: static;
            }

            #letterPage.active .container {
                width: 100%;
                height: auto;
                overflow: visible;
            }

            #letterPage.active .main-content {
                display: block !important;
                width: 100%;
                height: auto;
                overflow: visible;
                grid-template-columns: 1fr;
            }

            #letterPage.active .form-section {
                display: none !important;
            }

            #letterPage.active .letter-preview-container {
                background: white !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                width: 100%;
                height: auto;
                overflow: visible;
            }

            #letterPage.active .letter-preview {
                display: block !important;
                border: none !important;
                box-shadow: none !important;
                margin: 0 auto !important;
                padding: 15mm 20mm 15mm 30mm !important;
                background: white !important;
                width: 210mm !important;
                height: auto !important;
                min-height: 297mm !important;
                max-height: none !important;
                overflow: visible !important;
                page-break-after: always;
            }

            #letterPage.active .letter-preview * {
                visibility: visible !important;
            }

            #letterPage.active h1 {
                display: none !important;
            }

            /* ===== CV PAGE PRINT STYLES ===== */
            #cvPage.active {
                width: 100%;
                height: auto;
                overflow: visible;
                position: static;
                background: white;
                padding: 0 !important;
            }

            #cvPage.active .container {
                display: block !important;
                grid-template-columns: 1fr !important;
                width: 100%;
                height: auto;
                overflow: visible;
                max-width: none;
                margin: 0 !important;
            }

            #cvPage.active .form-section {
                display: none !important;
            }

            #cvPage.active .cv-preview {
                display: block !important;
                padding: 20px !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                background: white !important;
                width: 100%;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
            }

            #cvPage.active .cv-preview * {
                visibility: visible !important;
            }

            /* Remove scrollbar styles */
            *::-webkit-scrollbar {
                display: none !important;
            }

            * {
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }
        }
    
        /* ==================== MOBILE RESPONSIVE STYLES ==================== */
        @media (max-width: 1024px) {
            /* Letter Page - Stack layout on tablets */
            #letterPage .main-content {
                grid-template-columns: 1fr !important;
            }
            
            #letterPage .form-section {
                position: relative !important;
                top: auto !important;
                max-height: none !important;
                margin-bottom: 20px;
            }
            
            /* CV Page - Stack layout on tablets */
            #cvPage .container {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 768px) {
            /* Global mobile adjustments */
            body {
                padding: 10px !important;
            }

            /* Back button - smaller on mobile */
            .back-button {
                top: 10px;
                left: 10px;
                padding: 10px 18px;
                font-size: 13px;
            }

            /* Brand badge - smaller on mobile */
            .brand-badge {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px 15px;
            }

            /* Landing Page Mobile */
            #landingPage {
                padding: 15px;
            }

            #landingPage .brand-name {
                font-size: 18px;
            }

            #landingPage .landing-header h1 {
                font-size: 32px;
            }

            #landingPage .landing-header p {
                font-size: 16px;
            }

            #landingPage .cards-container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 10px;
            }

            #landingPage .card {
                padding: 35px 25px;
            }

            #landingPage .card-icon {
                font-size: 60px;
            }

            #landingPage .card h2 {
                font-size: 24px;
            }

            #landingPage .card p {
                font-size: 14px;
            }

            /* Letter Page Mobile */
            #letterPage {
                padding: 70px 10px 20px 10px !important;
            }

            #letterPage .container {
                padding: 0 !important;
            }

            #letterPage .main-content {
                grid-template-columns: 1fr !important;
                gap: 20px;
            }

            #letterPage .form-section {
                position: relative !important;
                top: auto !important;
                max-height: none !important;
                padding: 20px;
                margin-bottom: 20px;
            }

            #letterPage .form-section h2 {
                font-size: 16px;
            }

            #letterPage .form-group label {
                font-size: 12px;
            }

            #letterPage .form-group input,
            #letterPage .form-group select,
            #letterPage .form-group textarea {
                font-size: 14px;
                padding: 10px;
            }

            #letterPage button {
                font-size: 12px;
                padding: 10px 14px;
            }

            #letterPage .letter-preview {
                width: 100% !important;
                min-height: auto !important;
                max-height: none !important;
                padding: 10mm 15mm !important;
                font-size: 10pt;
            }

            #letterPage .letter-preview-container {
                padding: 10px;
            }

            #letterPage .passport-photo {
                width: 25mm;
                height: 32mm;
                top: 10mm;
                left: 15mm;
            }

            #letterPage .print-btn {
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 10px 18px;
                font-size: 13px;
            }

            /* CV Page Mobile */
            #cvPage {
                padding: 10px !important;
            }

            #cvPage .cv-header-buttons {
                margin: 10px;
                padding: 10px;
                flex-wrap: wrap;
            }

            #cvPage .cv-back-btn,
            #cvPage .cv-print-btn {
                flex: 1;
                min-width: 120px;
                padding: 10px 16px;
                font-size: 12px;
            }

            #cvPage .container {
                grid-template-columns: 1fr !important;
                gap: 15px;
                margin: 0 !important;
                padding: 0 !important;
            }

            #cvPage .form-section {
                padding: 20px;
                max-height: none !important;
                margin-bottom: 20px;
            }

            #cvPage h2 {
                font-size: 20px;
            }

            #cvPage .section-title {
                font-size: 12px;
            }

            #cvPage .form-group {
                margin-bottom: 15px;
            }

            #cvPage label {
                font-size: 12px;
            }

            #cvPage input,
            #cvPage textarea {
                font-size: 14px;
                padding: 10px;
            }

            #cvPage button {
                font-size: 13px;
                padding: 10px 20px;
            }

            #cvPage .cv-preview {
                padding: 20px 15px !important;
                max-height: none !important;
            }

            #cvPage .cv-name {
                font-size: 24px;
            }

            #cvPage .cv-title {
                font-size: 14px;
            }

            #cvPage .cv-contact {
                font-size: 11px;
                gap: 10px;
                flex-direction: column;
            }

            #cvPage .cv-section-title {
                font-size: 16px;
            }

            #cvPage .cv-item-title {
                font-size: 13px;
            }

            #cvPage .cv-item-subtitle,
            #cvPage .cv-item-date {
                font-size: 11px;
            }

            #cvPage .cv-item-description {
                font-size: 12px;
            }

            #cvPage .entry {
                padding: 15px;
            }

            #cvPage .move-btn {
                font-size: 10px;
                padding: 4px 8px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small mobile devices */
            #landingPage .landing-header h1 {
                font-size: 28px;
            }

            #landingPage .brand-name {
                font-size: 16px;
            }

            #landingPage .card {
                padding: 30px 20px;
            }

            #landingPage .card-icon {
                font-size: 50px;
            }

            #landingPage .card h2 {
                font-size: 22px;
            }

            #landingPage .card-button {
                padding: 12px 25px;
                font-size: 14px;
            }

            /* Letter and CV - even more compact */
            #letterPage,
            #cvPage {
                padding: 60px 5px 10px 5px !important;
            }

            .back-button {
                padding: 8px 12px;
                font-size: 12px;
            }

            #letterPage .form-section,
            #cvPage .form-section {
                padding: 15px;
            }

            #cvPage .cv-header-buttons {
                flex-direction: column;
                gap: 8px;
            }

            #cvPage .cv-back-btn,
            #cvPage .cv-print-btn {
                width: 100%;
            }

            #cvPage .cv-name {
                font-size: 20px;
            }

            #cvPage .cv-contact {
                font-size: 10px;
            }
        }

        /* Touch-friendly tap targets */
        @media (hover: none) and (pointer: coarse) {
            /* Increase tap target sizes on touch devices */
            button,
            .card,
            .back-button,
            .card-button {
                min-height: 44px;
                min-width: 44px;
            }

            input,
            select,
            textarea {
                min-height: 44px;
            }

            #cvPage .move-btn,
            #cvPage .remove-btn,
            #cvPage .add-btn {
                min-height: 44px;
                padding: 10px 15px;
            }
        }

    </style>
</head>
<body>
    <!-- Landing Page -->
    <div id="landingPage" class="page-section active">
        <div class="landing-container">
            <div class="landing-header">
                <div class="brand-name">Daniel Idrissa Ramadhan</div>
                <h1>Professional Writing Center</h1>
                <p>Choose what you'd like to create</p>
            </div>

            <div class="cards-container">
                <!-- Letter Writer Card -->
                <div class="card" onclick="showPage('letter'); return false;">
                    <div class="card-icon">âœ‰ï¸</div>
                    <h2>Write a Letter</h2>
                    <p>Create professional, formal letters with customizable templates, formatting options, and automatic layout generation.</p>
                    <button class="card-button" onclick="event.stopPropagation(); showPage('letter'); return false;">Start Writing</button>
                </div>

                <!-- CV Builder Card -->
                <div class="card" onclick="showPage('cv'); return false;">
                    <div class="card-icon">ðŸ“„</div>
                    <h2>Write a CV</h2>
                    <p>Build a comprehensive, professional curriculum vitae with customizable sections, modern design, and export options.</p>
                    <button class="card-button" onclick="event.stopPropagation(); showPage('cv'); return false;">Build Your CV</button>
                </div>
            </div>

            <div class="landing-footer">
                <p>Professional tools for your writing needs</p>
                <p class="creator">Created by Daniel Idrissa Ramadhan</p>
            </div>
        </div>
    </div>

    <!-- Letter Writer Page -->
    <div id="letterPage" class="page-section">
        <button class="back-button" onclick="showPage('landing'); return false;">â† Back to Home</button>
        <div class="brand-badge">Daniel Idrissa Ramadhan</div>

    <button class="print-btn" onclick="window.print()">ðŸ–¨ï¸ Print</button>

    <div class="container">
        <h1 style="text-align: center; margin-bottom: 30px; color: #333;">Professional Letter Writer</h1>

        <div class="main-content">
            <!-- Form Section -->
            <div class="form-section">
                <h2>âš™ï¸ Letter Configuration</h2>

                <!-- JSON Save/Load Buttons - Top -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button style="background-color: #9C27B0; flex: 1; min-width: 120px;" onclick="exportToJSON()">ðŸ’¾ Save as JSON</button>
                    <label class="file-upload-btn" style="background-color: #673AB7; flex: 1; min-width: 120px; display: inline-block; margin: 0; text-align: center; cursor: pointer;">
                        ðŸ“‚ Load from JSON
                        <input type="file" id="jsonImportTop" accept=".json" onchange="importFromJSON(event)"
                            style="display: none;">
                    </label>
                </div>

                <!-- Font Selection -->
                <div class="form-group">
                    <label>Font Family (Body Text)</label>
                    <select id="fontFamily" onchange="updateLetter()">
                        <option value="Bookman Old Style" selected>Bookman Old Style</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Garamond">Garamond</option>
                        <option value="Palatino Linotype">Palatino Linotype</option>
                        <option value="Baskerville">Baskerville</option>
                        <option value="Cambria">Cambria</option>
                        <option value="Century">Century</option>
                        <option value="Arial">Arial</option>
                        <option value="Calibri">Calibri</option>
                        <option value="Helvetica">Helvetica</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Trebuchet MS">Trebuchet MS</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Consolas">Consolas</option>
                    </select>
                </div>

                <!-- Header Customization -->
                <div class="section-divider"></div>
                <h2>ðŸŽ¨ Header Components Styling</h2>
                <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                    Customize font size, style, and spacing for addresses, salutation, reference header, valediction, and signature (NOT the main body text)
                </div>

                <div class="form-group">
                    <label>Header Font Size (pt)</label>
                    <input type="number" id="headerFontSize" value="10" min="8" max="16" step="0.5" onchange="updateLetter()">
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="headerBold" onchange="updateLetter()">
                    <label>Bold Header Text</label>
                </div>

                <div class="form-group">
                    <label>Letter Spacing (px)</label>
                    <input type="number" id="headerLetterSpacing" value="0" min="-2" max="5" step="0.5" onchange="updateLetter()">
                </div>

                <div class="form-group">
                    <label>Line Height</label>
                    <input type="number" id="headerLineHeight" value="1.6" min="1" max="3" step="0.1" onchange="updateLetter()">
                </div>

                <div class="section-divider"></div>
                <h2>ðŸ“¸ Optional Images</h2>

                <!-- Passport Photo Upload -->
                <div class="form-group">
                    <label>Passport Photo (Optional)</label>
                    <label class="file-upload-btn">
                        ðŸ“· Upload Passport Photo
                        <input type="file" id="passportPhoto" accept="image/*" onchange="handlePassportPhoto(event)">
                    </label>
                    <div style="margin-top: 5px;">
                        <button class="secondary-btn" style="padding: 5px 10px; font-size: 11px;"
                            onclick="removePassportPhoto()">Remove Photo</button>
                    </div>
                </div>

                <div class="section-divider"></div>
                <h2>ðŸ‘¤ Sender Details (You)</h2>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="senderName" placeholder="Your full name" oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="senderAddress" placeholder="Street address" oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="senderCity" placeholder="City name" oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="senderPhone" placeholder="e.g., +255 123 456 789" oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showSenderEmail" checked onchange="updateLetter()">
                        <label for="showSenderEmail" style="margin-bottom: 0;">Show Email</label>
                    </div>
                    <input type="email" id="senderEmail" placeholder="your.email@example.com" oninput="updateLetter()"
                        style="margin-top: 5px;">
                </div>

                <div class="form-group">
                    <label>Custom Details (Optional)</label>
                    <div id="customDetailsContainer">
                        <div class="custom-detail-item" style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <input type="text" class="customDetail" placeholder="e.g., P.O. Box 12345"
                                oninput="updateLetter()" style="flex: 1;">
                            <button type="button" class="secondary-btn" style="padding: 8px 12px;"
                                onclick="removeCustomDetail(this)">âœ•</button>
                        </div>
                    </div>
                    <button type="button" style="padding: 6px 12px; font-size: 12px; margin-top: 5px;"
                        onclick="addCustomDetail()">+ Add Custom Detail</button>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date" oninput="updateLetter()">
                </div>

                <div class="section-divider"></div>
                <h2>ðŸ“¬ Receiver Details</h2>

                <div class="form-group">
                    <label>Title/Position</label>
                    <input type="text" id="receiverTitle" placeholder="e.g., Director, Manager"
                        oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <label>Organization</label>
                    <input type="text" id="receiverOrg" placeholder="Organization name" oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="receiverAddress" placeholder="Street address" oninput="updateLetter()">
                </div>

                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="receiverCity" placeholder="City name" oninput="updateLetter()">
                </div>

                <div class="section-divider"></div>
                <h2>ðŸ“¨ Through/KK Section (Optional)</h2>

                <div class="form-group">
                    <div class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="showThrough" onchange="toggleThroughSection()">
                        <label for="showThrough" style="margin-bottom: 0;">Show Through/KK Section</label>
                    </div>
                </div>

                <div id="throughSectionInputs" style="display: none;">
                    <div class="form-group">
                        <label>Through/KK Type</label>
                        <select id="throughType" onchange="updateLetter()">
                            <option value="THROUGH" selected>THROUGH:</option>
                            <option value="KK">KK:</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Title/Position</label>
                        <input type="text" id="throughTitle" placeholder="e.g., Director, Manager"
                            oninput="updateLetter()">
                    </div>

                    <div class="form-group">
                        <label>Organization</label>
                        <input type="text" id="throughOrg" placeholder="Organization name" oninput="updateLetter()">
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="throughAddress" placeholder="Street address" oninput="updateLetter()">
                    </div>

                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="throughCity" placeholder="City name" oninput="updateLetter()">
                    </div>
                </div>

                <div class="section-divider"></div>
                <h2>âœ‰ï¸ Letter Content</h2>

                <!-- Salutation -->
                <div class="form-group">
                    <div class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="showSalutation" checked onchange="updateLetter()">
                        <label for="showSalutation" style="margin-bottom: 0;">Show Salutation</label>
                    </div>
                    <label>Salutation</label>
                    <select id="salutation" onchange="handleSalutationChange()">
                        <option value="Ndugu" selected>Ndugu</option>
                        <option value="Ndugu Mkurugenzi">Ndugu Mkurugenzi</option>
                        <option value="Mh.">Mh.</option>
                        <option value="Your Holiness">Your Holiness</option>
                        <option value="Your Excellency">Your Excellency</option>
                        <option value="Your Majesty">Your Majesty</option>
                        <option value="Dear Sir/Madam">Dear Sir/Madam</option>
                        <option value="Dear Sir">Dear Sir</option>
                        <option value="Dear Madam">Dear Madam</option>
                        <option value="To Whom It May Concern">To Whom It May Concern</option>
                        <option value="Respected Sir/Madam">Respected Sir/Madam</option>
                        <option value="CUSTOM">Custom (Type your own)</option>
                    </select>
                    <input type="text" id="customSalutation" placeholder="Enter custom salutation"
                        oninput="updateLetter()" style="margin-top: 8px; display: none;">
                </div>

                <!-- Letter Header (REF/YAH) -->
                <div class="form-group">
                    <label>Letter Header (REF/YAH)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <select id="refType" onchange="updateLetter()" style="width: 80px;">
                            <option value="REF">REF</option>
                            <option value="YAH" selected>YAH</option>
                        </select>
                        <input type="text" id="refHeader" placeholder="e.g., Application for Employment"
                            oninput="updateLetter()" style="flex: 1;">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showRefHeader" checked onchange="updateLetter()">
                        <label for="showRefHeader" style="margin-bottom: 0;">Show Header</label>
                    </div>
                </div>

                <!-- Body Text with Formatting -->
                <div class="form-group">
                    <label>Letter Body</label>
                    <div class="toolbar">
                        <button onclick="formatText('bold')" title="Bold"><b>B</b></button>
                        <button onclick="formatText('italic')" title="Italic"><i>I</i></button>
                        <button onclick="formatText('underline')" title="Underline"><u>U</u></button>
                        <button onclick="formatText('strikethrough')" title="Strikethrough"><s>S</s></button>
                        <input type="color" id="textColor" value="#000000" onchange="formatText('color')"
                            title="Text Color">
                        <label style="font-size: 11px; margin: 0 5px;">Spacing:</label>
                        <input type="number" id="lineSpacing" value="1.6" step="0.1" min="1" max="3"
                            style="width: 60px;" onchange="updateLetter()" title="Line Spacing">
                    </div>
                    <textarea id="body" rows="8"
                        placeholder="Type your letter content. Press Enter for new paragraphs..."
                        oninput="updateLetter()"></textarea>
                    <div class="checkbox-group" style="margin-top: 8px;">
                        <input type="checkbox" id="indentParagraphs" checked onchange="updateLetter()">
                        <label for="indentParagraphs" style="margin-bottom: 0;">Indent Paragraphs</label>
                    </div>
                </div>

                <!-- Valediction -->
                <div class="form-group">
                    <label>Valediction (Closing)</label>
                    <select id="valediction" onchange="handleValedictionChange()">
                        <option value="Wako katika Kazi" selected>Wako katika Kazi</option>
                        <option value="Mimi">Mimi</option>
                        <option value="Wako Mtiifu">Wako Mtiifu</option>
                        <option value="Wako Katika Ujenzi wa Taifa">Wako Katika Ujenzi wa Taifa</option>
                        <option value="Wako Mwaminifu">Wako Mwaminifu</option>
                        <option value="Kwa Moyo Mkunjufu">Kwa Moyo Mkunjufu</option>
                        <option value="Yours faithfully">Yours faithfully</option>
                        <option value="Yours sincerely">Yours sincerely</option>
                        <option value="Humbly">Humbly</option>
                        <option value="Kindly">Kindly</option>
                        <option value="With Honours">With Honours</option>
                        <option value="Sincerely">Sincerely</option>
                        <option value="With Gratitude">With Gratitude</option>
                        <option value="Yours Esteemed">Yours Esteemed</option>
                        <option value="Warm Wishes">Warm Wishes</option>
                        <option value="With Blessings">With Blessings</option>
                        <option value="Lovable">Lovable</option>
                        <option value="Warmly">Warmly</option>
                        <option value="Beseeching">Beseeching</option>
                        <option value="With Hugs">With Hugs</option>
                        <option value="Missing you">Missing you</option>
                        <option value="With Love â™¥ï¸">With Love â™¥ï¸</option>
                        <option value="Best Regards">Best Regards</option>
                        <option value="Kind Regards">Kind Regards</option>
                        <option value="CUSTOM">Custom (Type your own)</option>
                    </select>
                    <input type="text" id="customValediction" placeholder="Enter custom valediction"
                        oninput="updateLetter()" style="margin-top: 8px; display: none;">
                </div>

                <div class="section-divider"></div>
                <h2>âœï¸ Signature</h2>

                <div class="form-group">
                    <label>Signature Options</label>
                    <div style="margin-bottom: 10px;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showSignatureLine" checked onchange="updateLetter()">
                            <label for="showSignatureLine" style="margin-bottom: 0;">Show Signature Line</label>
                        </div>
                    </div>
                </div>

                <!-- Signature Image Upload -->
                <div class="form-group">
                    <label>Import Signature Image</label>
                    <label class="file-upload-btn">
                        ðŸ–Šï¸ Upload Signature
                        <input type="file" id="signatureImage" accept="image/*" onchange="handleSignatureImage(event)">
                    </label>
                    <div style="margin-top: 5px;">
                        <button class="secondary-btn" style="padding: 5px 10px; font-size: 11px;"
                            onclick="removeSignature()">Remove Signature</button>
                    </div>
                </div>

                <div class="section-divider"></div>
                <h2>ðŸ’¾ Export Options</h2>

                <div
                    style="background-color: #E3F2FD; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">ðŸ”¶ Server Status: <span id="serverStatus"
                            style="color: #FF9800;">Checking...</span></div>
                    <div style="font-size: 11px; color: #666;">
                        âœ… All features work offline<br>
                        ðŸ“„ Print/PDF work without server<br>
                        ðŸ“‹ Word export needs server running
                    </div>
                </div>

                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToWord()">ðŸ“„ Export to Word</button>
                    <button class="export-btn" onclick="exportToPDF()">ðŸ“‘ Export to PDF</button>
                    <button style="background-color: #9C27B0;" onclick="exportToJSON()">ðŸ’¾ Save as JSON</button>
                    <label class="file-upload-btn" style="background-color: #673AB7; display: inline-block; margin: 0;">
                        ðŸ“‚ Load from JSON
                        <input type="file" id="jsonImport" accept=".json" onchange="importFromJSON(event)"
                            style="display: none;">
                    </label>
                </div>

                <div
                    style="margin-top: 10px; padding: 10px; background-color: #F3E5F5; border-radius: 5px; font-size: 11px;">
                    <strong>ðŸ’¡ Tip:</strong> Save your letter as JSON to reload it later or create templates for
                    different recipients!
                </div>
            </div>

            <!-- Letter Preview -->
            <div class="letter-preview-container">
                <div class="preview-label">ðŸ“„ Live Preview (A4 Size - Optimized for One Page)</div>
                <div class="letter-preview" id="letterPreview">
                    <img id="passportPhotoPreview" class="passport-photo" style="display: none;">

                    <div class="sender-address" id="senderAddressDisplay"></div>
                    <div class="receiver-address" id="receiverAddressDisplay"></div>
                    <div class="through-address" id="throughAddressDisplay" style="display: none;"></div>

                    <div class="salutation" id="salutationDisplay"></div>
                    <div class="letter-ref-header" id="letterRefHeader"></div>
                    <div class="letter-body" id="letterBody"></div>
                    <div class="valediction" id="valedictionDisplay"></div>
                    <div class="signature-section" id="signatureSection"></div>
                    
                    <!-- Page Number at Bottom Right -->
                    <div style="position: absolute; bottom: 15mm; right: 20mm; font-size: 10pt; color: #333;">1</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        let passportPhotoData = null;
        let signatureImageData = null;

        // Check server status on load
        function checkServerStatus() {
            fetch('http://localhost:5000/health', {
                method: 'GET',
                timeout: 2000
            })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('serverStatus').textContent = 'Connected âœ”';
                        document.getElementById('serverStatus').style.color = '#4CAF50';
                    } else {
                        throw new Error('Server not responding');
                    }
                })
                .catch(error => {
                    document.getElementById('serverStatus').textContent = 'Offline (Browser mode)';
                    document.getElementById('serverStatus').style.color = '#FF9800';
                });
        }

        // Check status on load
        checkServerStatus();

        // Recheck every 30 seconds
        setInterval(checkServerStatus, 30000);

        function toggleThroughSection() {
            const showThrough = document.getElementById('showThrough').checked;
            const throughInputs = document.getElementById('throughSectionInputs');
            
            if (showThrough) {
                throughInputs.style.display = 'block';
            } else {
                throughInputs.style.display = 'none';
            }
            
            updateLetter();
        }

        function addCustomDetail() {
            const container = document.getElementById('customDetailsContainer');
            const newDetail = document.createElement('div');
            newDetail.className = 'custom-detail-item';
            newDetail.style.display = 'flex';
            newDetail.style.gap = '5px';
            newDetail.style.marginBottom = '5px';
            newDetail.innerHTML = `
                <input type="text" class="customDetail" placeholder="e.g., P.O. Box 12345" oninput="updateLetter()" style="flex: 1;">
                <button type="button" class="secondary-btn" style="padding: 8px 12px;" onclick="removeCustomDetail(this)">âœ•</button>
            `;
            container.appendChild(newDetail);
        }

        function removeCustomDetail(button) {
            const container = document.getElementById('customDetailsContainer');
            const items = container.getElementsByClassName('custom-detail-item');

            // Keep at least one custom detail field
            if (items.length > 1) {
                button.parentElement.remove();
                updateLetter();
            }
        }

        function handlePassportPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    passportPhotoData = e.target.result;
                    updateLetter();
                };
                reader.readAsDataURL(file);
            }
        }

        function removePassportPhoto() {
            passportPhotoData = null;
            document.getElementById('passportPhoto').value = '';
            updateLetter();
        }

        function handleSignatureImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    signatureImageData = e.target.result;
                    updateLetter();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeSignature() {
            signatureImageData = null;
            document.getElementById('signatureImage').value = '';
            updateLetter();
        }

        function handleSalutationChange() {
            const salutation = document.getElementById('salutation').value;
            const customInput = document.getElementById('customSalutation');

            if (salutation === 'CUSTOM') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
            updateLetter();
        }

        function handleValedictionChange() {
            const valediction = document.getElementById('valediction').value;
            const customInput = document.getElementById('customValediction');

            if (valediction === 'CUSTOM') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
            updateLetter();
        }

        function formatText(command) {
            const textarea = document.getElementById('body');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (selectedText) {
                let formattedText = selectedText;
                let tag = '';

                switch (command) {
                    case 'bold':
                        tag = 'b';
                        break;
                    case 'italic':
                        tag = 'i';
                        break;
                    case 'underline':
                        tag = 'u';
                        break;
                    case 'strikethrough':
                        tag = 's';
                        break;
                    case 'color':
                        const color = document.getElementById('textColor').value;
                        formattedText = `<span style="color: ${color}">${selectedText}</span>`;
                        break;
                }

                if (tag) {
                    formattedText = `<${tag}>${selectedText}</${tag}>`;
                }

                textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
                updateLetter();
            }
        }

        function updateLetter() {
            const fontFamily = document.getElementById('fontFamily').value;
            const letterPreview = document.getElementById('letterPreview');
            letterPreview.style.fontFamily = fontFamily;

            // Passport Photo
            const passportPhoto = document.getElementById('passportPhotoPreview');
            if (passportPhotoData) {
                passportPhoto.src = passportPhotoData;
                passportPhoto.style.display = 'block';
            } else {
                passportPhoto.style.display = 'none';
            }

            // Sender Address (Right side at top)
            const senderName = document.getElementById('senderName').value;
            const senderAddress = document.getElementById('senderAddress').value;
            const senderCity = document.getElementById('senderCity').value;
            const senderPhone = document.getElementById('senderPhone').value;
            const senderEmail = document.getElementById('senderEmail').value;
            const showSenderEmail = document.getElementById('showSenderEmail').checked;

            // Collect all custom details
            const customDetailInputs = document.getElementsByClassName('customDetail');
            const senderCustomDetails = [];
            for (let i = 0; i < customDetailInputs.length; i++) {
                if (customDetailInputs[i].value.trim()) {
                    senderCustomDetails.push(customDetailInputs[i].value.trim());
                }
            }

            const date = document.getElementById('date').value;

            let senderHTML = '';
            if (senderName) senderHTML += `<div class="address-line">${senderName},</div>`;
            if (senderAddress) senderHTML += `<div class="address-line">${senderAddress},</div>`;
            if (senderCity) senderHTML += `<div class="address-line">${senderCity},</div>`;
            if (senderPhone) senderHTML += `<div class="address-line">${senderPhone},</div>`;
            if (senderEmail && showSenderEmail) senderHTML += `<div class="address-line">${senderEmail},</div>`;

            // Add all custom details
            senderCustomDetails.forEach(detail => {
                senderHTML += `<div class="address-line">${detail},</div>`;
            });

            if (date) {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                senderHTML += `<div class="address-line" style="margin-top: 8px;">${formattedDate}.</div>`;
            }

            document.getElementById('senderAddressDisplay').innerHTML = senderHTML;

            // Receiver Address (Left side)
            const receiverTitle = document.getElementById('receiverTitle').value;
            const receiverOrg = document.getElementById('receiverOrg').value;
            const receiverAddress = document.getElementById('receiverAddress').value;
            const receiverCity = document.getElementById('receiverCity').value;

            let receiverHTML = '';
            if (receiverTitle) receiverHTML += `<div class="address-line">${receiverTitle},</div>`;
            if (receiverOrg) receiverHTML += `<div class="address-line">${receiverOrg},</div>`;
            if (receiverAddress) receiverHTML += `<div class="address-line">${receiverAddress},</div>`;
            if (receiverCity) receiverHTML += `<div class="address-line">${receiverCity}.</div>`;

            document.getElementById('receiverAddressDisplay').innerHTML = receiverHTML;

            // Through Address (if enabled)
            const showThrough = document.getElementById('showThrough').checked;
            const throughDisplay = document.getElementById('throughAddressDisplay');
            
            if (showThrough) {
                const throughType = document.getElementById('throughType').value;
                const throughTitle = document.getElementById('throughTitle').value;
                const throughOrg = document.getElementById('throughOrg').value;
                const throughAddress = document.getElementById('throughAddress').value;
                const throughCity = document.getElementById('throughCity').value;

                let throughHTML = `<div class="address-line" style="font-weight: bold; margin-bottom: 8px;">${throughType}</div>`;
                
                if (throughTitle) throughHTML += `<div class="address-line">${throughTitle},</div>`;
                if (throughOrg) throughHTML += `<div class="address-line">${throughOrg},</div>`;
                if (throughAddress) throughHTML += `<div class="address-line">${throughAddress},</div>`;
                if (throughCity) throughHTML += `<div class="address-line">${throughCity}.</div>`;

                throughDisplay.innerHTML = throughHTML;
                throughDisplay.style.display = 'block';
            } else {
                throughDisplay.style.display = 'none';
            }

            // Salutation
            const showSalutation = document.getElementById('showSalutation').checked;
            const salutationSelect = document.getElementById('salutation').value;
            let salutationText = '';

            if (showSalutation) {
                if (salutationSelect === 'CUSTOM') {
                    salutationText = document.getElementById('customSalutation').value || 'Ndugu';
                } else {
                    salutationText = salutationSelect;
                }
                document.getElementById('salutationDisplay').textContent = salutationText + ',';
                document.getElementById('salutationDisplay').style.display = 'block';
            } else {
                document.getElementById('salutationDisplay').style.display = 'none';
            }

            // Letter Header (REF/YAH)
            const showRefHeader = document.getElementById('showRefHeader').checked;
            const refType = document.getElementById('refType').value;
            let refHeader = document.getElementById('refHeader').value;

            if (showRefHeader && refHeader) {
                if (!refHeader.endsWith('.')) {
                    refHeader += '.';
                }
                document.getElementById('letterRefHeader').innerHTML = `${refType}: <span style="font-weight: bold;">${refHeader}</span>`;
                document.getElementById('letterRefHeader').style.display = 'block';
            } else {
                document.getElementById('letterRefHeader').style.display = 'none';
            }

            // Body
            const body = document.getElementById('body').value;
            const indentParagraphs = document.getElementById('indentParagraphs').checked;
            const lineSpacing = document.getElementById('lineSpacing').value;
            const paragraphs = body.split('\n').filter(p => p.trim() !== '');

            let bodyHTML = '';
            paragraphs.forEach(paragraph => {
                const className = indentParagraphs ? 'indented' : '';
                bodyHTML += `<p class="${className}" style="line-height: ${lineSpacing};">${paragraph}</p>`;
            });

            document.getElementById('letterBody').innerHTML = bodyHTML;
            document.getElementById('letterBody').style.lineHeight = lineSpacing;

            // Valediction
            const valedictionSelect = document.getElementById('valediction').value;
            let valedictionText = '';

            if (valedictionSelect === 'CUSTOM') {
                valedictionText = document.getElementById('customValediction').value || 'Wako katika Kazi';
            } else {
                valedictionText = valedictionSelect;
            }
            document.getElementById('valedictionDisplay').textContent = valedictionText + ',';

            // Signature
            const showSignatureLine = document.getElementById('showSignatureLine').checked;

            let signatureHTML = '';

            if (signatureImageData) {
                signatureHTML += `<img src="${signatureImageData}" class="signature-image">`;
            }

            if (showSignatureLine) {
                signatureHTML += `<div class="signature-line">
                    <div class="signature-name">${senderName || '(Your Name)'}</div>`;

                if (senderPhone) {
                    signatureHTML += `<div class="signature-contact">${senderPhone}</div>`;
                }

                if (senderEmail && showSenderEmail) {
                    signatureHTML += `<div class="signature-contact">${senderEmail}</div>`;
                }

                signatureHTML += `</div>`;
            } else if (senderName && !signatureImageData) {
                signatureHTML += `<div style="margin-top: 40px;">
                    <div class="signature-name">${senderName}</div>`;

                if (senderPhone) {
                    signatureHTML += `<div class="signature-contact">${senderPhone}</div>`;
                }

                if (senderEmail && showSenderEmail) {
                    signatureHTML += `<div class="signature-contact">${senderEmail}</div>`;
                }

                signatureHTML += `</div>`;
            }

            document.getElementById('signatureSection').innerHTML = signatureHTML;

            // Apply Header Customization (after all HTML is generated)
            const headerFontSize = document.getElementById('headerFontSize').value;
            const headerBold = document.getElementById('headerBold').checked;
            const headerLetterSpacing = document.getElementById('headerLetterSpacing').value;
            const headerLineHeight = document.getElementById('headerLineHeight').value;

            // Apply header styles to all header components including sender/receiver details (NOT the main body)
            const headerElements = document.querySelectorAll('.sender-address, .receiver-address, .through-address, .address-line, .salutation, .letter-ref-header, .valediction, .signature-section, .signature-name, .signature-contact, .signature-line');
            headerElements.forEach(element => {
                element.style.fontSize = headerFontSize + 'pt';
                element.style.fontWeight = headerBold ? 'bold' : 'normal';
                element.style.letterSpacing = headerLetterSpacing + 'px';
                element.style.lineHeight = headerLineHeight;
            });
        }

        function exportToWord() {
            const letterData = collectLetterData();

            // Send to server
            fetch('http://localhost:5000/export/word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(letterData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Server not available');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'letter.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Word export requires the export server.\n\nTo use Word export:\n1. Run: python letter_export_server.py\n2. Or use "Export to PDF" or "Print" instead (fully offline)');
                });
        }

        function exportToPDF() {
            const letterData = collectLetterData();

            // Try to use export server first
            fetch('http://localhost:5000/export/pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(letterData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Server not available');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'letter.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    // Fallback to browser print (fully offline)
                    console.log('Using browser print (offline mode)');
                    if (confirm('Export server not available. Use browser Print to PDF instead?\n\nClick OK, then choose "Save as PDF" in the print dialog.')) {
                        window.print();
                    }
                });
        }

        function collectLetterData() {
            // Collect all custom details
            const customDetailInputs = document.getElementsByClassName('customDetail');
            const senderCustomDetails = [];
            for (let i = 0; i < customDetailInputs.length; i++) {
                if (customDetailInputs[i].value.trim()) {
                    senderCustomDetails.push(customDetailInputs[i].value.trim());
                }
            }

            return {
                font: document.getElementById('fontFamily').value,
                headerFontSize: document.getElementById('headerFontSize').value,
                headerBold: document.getElementById('headerBold').checked,
                headerLetterSpacing: document.getElementById('headerLetterSpacing').value,
                headerLineHeight: document.getElementById('headerLineHeight').value,
                passportPhoto: passportPhotoData,
                senderName: document.getElementById('senderName').value,
                senderAddress: document.getElementById('senderAddress').value,
                senderCity: document.getElementById('senderCity').value,
                senderPhone: document.getElementById('senderPhone').value,
                senderEmail: document.getElementById('senderEmail').value,
                showSenderEmail: document.getElementById('showSenderEmail').checked,
                senderCustomDetails: senderCustomDetails,
                date: document.getElementById('date').value ? new Date(document.getElementById('date').value).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : '',
                receiverTitle: document.getElementById('receiverTitle').value,
                receiverOrg: document.getElementById('receiverOrg').value,
                receiverAddress: document.getElementById('receiverAddress').value,
                receiverCity: document.getElementById('receiverCity').value,
                showThrough: document.getElementById('showThrough').checked,
                throughType: document.getElementById('throughType').value,
                throughTitle: document.getElementById('throughTitle').value,
                throughOrg: document.getElementById('throughOrg').value,
                throughAddress: document.getElementById('throughAddress').value,
                throughCity: document.getElementById('throughCity').value,
                showSalutation: document.getElementById('showSalutation').checked,
                salutation: document.getElementById('salutation').value === 'CUSTOM'
                    ? document.getElementById('customSalutation').value
                    : document.getElementById('salutation').value,
                showRefHeader: document.getElementById('showRefHeader').checked,
                refType: document.getElementById('refType').value,
                refHeader: document.getElementById('refHeader').value,
                body: document.getElementById('body').value,
                indentParagraphs: document.getElementById('indentParagraphs').checked,
                valediction: document.getElementById('valediction').value === 'CUSTOM'
                    ? document.getElementById('customValediction').value
                    : document.getElementById('valediction').value,
                showSignatureLine: document.getElementById('showSignatureLine').checked,
                signatureImage: signatureImageData
            };
        }

        function exportToJSON() {
            const letterData = collectLetterData();

            // Add images as base64
            letterData.passportPhotoBase64 = passportPhotoData;
            letterData.signatureImageBase64 = signatureImageData;

            // Convert to JSON
            const jsonString = JSON.stringify(letterData, null, 2);

            // Create blob
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);

            // Generate filename from sender's name
            const senderName = document.getElementById('senderName').value || 'Letter';
            const filename = `${senderName.replace(/[^a-z0-9]/gi, '_')}_Letter_Barua.json`;

            // Download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            alert(`Letter saved as: ${filename}\n\nYou can reload this letter anytime using "Load from JSON"!`);
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const letterData = JSON.parse(e.target.result);

                    // Restore all form fields
                    document.getElementById('fontFamily').value = letterData.font || 'Bookman Old Style';
                    document.getElementById('headerFontSize').value = letterData.headerFontSize || 10;
                    document.getElementById('headerBold').checked = letterData.headerBold || false;
                    document.getElementById('headerLetterSpacing').value = letterData.headerLetterSpacing || 0;
                    document.getElementById('headerLineHeight').value = letterData.headerLineHeight || 1.6;
                    document.getElementById('senderName').value = letterData.senderName || '';
                    document.getElementById('senderAddress').value = letterData.senderAddress || '';
                    document.getElementById('senderCity').value = letterData.senderCity || '';
                    document.getElementById('senderPhone').value = letterData.senderPhone || '';
                    document.getElementById('senderEmail').value = letterData.senderEmail || '';
                    document.getElementById('showSenderEmail').checked = letterData.showSenderEmail !== false;

                    // Restore date
                    if (letterData.date) {
                        // Convert from formatted date back to YYYY-MM-DD
                        const dateInput = document.getElementById('date');
                        dateInput.valueAsDate = new Date();
                    }

                    // Restore custom details
                    const container = document.getElementById('customDetailsContainer');
                    container.innerHTML = ''; // Clear existing
                    if (letterData.senderCustomDetails && letterData.senderCustomDetails.length > 0) {
                        letterData.senderCustomDetails.forEach(detail => {
                            const newDetail = document.createElement('div');
                            newDetail.className = 'custom-detail-item';
                            newDetail.style.display = 'flex';
                            newDetail.style.gap = '5px';
                            newDetail.style.marginBottom = '5px';
                            newDetail.innerHTML = `
                                <input type="text" class="customDetail" value="${detail}" oninput="updateLetter()" style="flex: 1;">
                                <button type="button" class="secondary-btn" style="padding: 8px 12px;" onclick="removeCustomDetail(this)">âœ•</button>
                            `;
                            container.appendChild(newDetail);
                        });
                    } else {
                        // Add at least one empty field
                        addCustomDetail();
                    }

                    // Restore receiver details
                    document.getElementById('receiverTitle').value = letterData.receiverTitle || '';
                    document.getElementById('receiverOrg').value = letterData.receiverOrg || '';
                    document.getElementById('receiverAddress').value = letterData.receiverAddress || '';
                    document.getElementById('receiverCity').value = letterData.receiverCity || '';

                    // Restore through section
                    document.getElementById('showThrough').checked = letterData.showThrough || false;
                    document.getElementById('throughType').value = letterData.throughType || 'THROUGH';
                    document.getElementById('throughTitle').value = letterData.throughTitle || '';
                    document.getElementById('throughOrg').value = letterData.throughOrg || '';
                    document.getElementById('throughAddress').value = letterData.throughAddress || '';
                    document.getElementById('throughCity').value = letterData.throughCity || '';
                    toggleThroughSection();

                    // Restore salutation
                    document.getElementById('showSalutation').checked = letterData.showSalutation !== false;
                    const salutationValue = letterData.salutation || 'Ndugu';
                    const salutationSelect = document.getElementById('salutation');
                    // Check if it's a preset value
                    let foundSalutation = false;
                    for (let option of salutationSelect.options) {
                        if (option.value === salutationValue) {
                            salutationSelect.value = salutationValue;
                            foundSalutation = true;
                            break;
                        }
                    }
                    if (!foundSalutation) {
                        salutationSelect.value = 'CUSTOM';
                        document.getElementById('customSalutation').value = salutationValue;
                        document.getElementById('customSalutation').style.display = 'block';
                    }

                    // Restore letter header
                    document.getElementById('showRefHeader').checked = letterData.showRefHeader !== false;
                    document.getElementById('refType').value = letterData.refType || 'YAH';
                    document.getElementById('refHeader').value = letterData.refHeader || '';

                    // Restore body
                    document.getElementById('body').value = letterData.body || '';
                    document.getElementById('indentParagraphs').checked = letterData.indentParagraphs !== false;

                    // Restore valediction
                    const valedictionValue = letterData.valediction || 'Wako katika Kazi';
                    const valedictionSelect = document.getElementById('valediction');
                    let foundValediction = false;
                    for (let option of valedictionSelect.options) {
                        if (option.value === valedictionValue) {
                            valedictionSelect.value = valedictionValue;
                            foundValediction = true;
                            break;
                        }
                    }
                    if (!foundValediction) {
                        valedictionSelect.value = 'CUSTOM';
                        document.getElementById('customValediction').value = valedictionValue;
                        document.getElementById('customValediction').style.display = 'block';
                    }

                    // Restore signature
                    document.getElementById('showSignatureLine').checked = letterData.showSignatureLine !== false;

                    // Restore images
                    if (letterData.passportPhotoBase64) {
                        passportPhotoData = letterData.passportPhotoBase64;
                    }
                    if (letterData.signatureImageBase64) {
                        signatureImageData = letterData.signatureImageBase64;
                    }

                    // Update preview
                    updateLetter();

                    alert('Letter loaded successfully!\n\nAll data has been restored from the JSON file.');

                } catch (error) {
                    alert('Error loading JSON file:\n' + error.message);
                    console.error('JSON import error:', error);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Initialize letter
        updateLetter();
    </script>

    </div>

    <!-- CV Builder Page -->
    <div id="cvPage" class="page-section">
        <div class="brand-badge">Daniel Idrissa Ramadhan</div>

    <div class="cv-header-buttons">
        <button class="cv-back-btn" onclick="showPage('landing'); return false;">â† Back</button>
        <button class="cv-print-btn" onclick="window.print()">ðŸ–¨ï¸ Print</button>
    </div>
    <div class="container">
        <!-- Form Section -->
        <div class="form-section">
            <h2>ðŸ“ CV Builder</h2>
            
            <!-- Text Case Selector -->
            <div class="section-title">Text Case Style</div>
            <div class="form-group">
                <label>Select Text Case for CV Content</label>
                <select id="textCase" onchange="updateCV()" style="padding: 12px; width: 100%; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Bookman Old Style', serif;">
                    <option value="capitalize">Sentence Case (Default)</option>
                    <option value="uppercase">UPPERCASE</option>
                    <option value="lowercase">lowercase</option>
                    <option value="none">As Typed</option>
                </select>
            </div>

            <!-- Photo Upload -->
            <div class="section-title">Photo</div>
            <div class="form-group">
                <label>Profile Picture (Optional)</label>
                <input type="file" id="photoUpload" accept="image/*" onchange="handlePhotoUpload(event)">
            </div>

            <!-- Personal Information -->
            <div class="section-title">Personal Information</div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" placeholder="John Doe" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Date Of Birth</label>
                <input type="text" id="dob" placeholder="01 January 1990" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Sex/Gender</label>
                <input type="text" id="gender" placeholder="Male/Female" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Nationality</label>
                <input type="text" id="nationality" placeholder="American" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Language</label>
                <input type="text" id="language" placeholder="English, Spanish" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Marital Status</label>
                <input type="text" id="maritalStatus" placeholder="Single/Married" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="phone" placeholder="+1234567890" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="email" placeholder="john@example.com" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" id="address" placeholder="City, Country" oninput="updateCV()">
            </div>

            <!-- Custom Personal Details -->
            <div class="section-title">Custom Personal Details</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Add additional custom fields</p>
            <div id="customDetailsContainer"></div>
            <button class="add-btn" onclick="addCustomDetail()">+ Add Custom Detail</button>

            <!-- Professional Summary -->
            <div class="section-title">Professional Summary</div>
            <div class="form-group">
                <label>Summary</label>
                <textarea id="summary" placeholder="Brief professional summary..." oninput="updateCV()"></textarea>
            </div>

            <!-- Section Order Control -->
            <div class="section-title">Section Order</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Use arrow buttons below to reorder sections</p>
            <div id="sectionOrderContainer"></div>

            <!-- Education -->
            <div class="section-title" data-section="education">
                <span>Education Background</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('education')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('education')">â†“</button>
                </div>
            </div>
            <div id="educationContainer"></div>
            <button class="add-btn" onclick="addEducation()">+ Add Education</button>
            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                <label style="font-size: 12px; font-weight: 700; margin-bottom: 8px; display: block;">Show Columns:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="eduCol-qualification" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Qualification
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="eduCol-institution" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Institution
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="eduCol-location" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Location
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="eduCol-period" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Period
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="eduCol-details" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Details
                    </label>
                </div>
            </div>

            <!-- Skills -->
            <div class="section-title" data-section="skills">
                <span>Skills</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('skills')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('skills')">â†“</button>
                </div>
            </div>
            <div class="form-group">
                <label>Skills (comma-separated)</label>
                <input type="text" id="skills" placeholder="JavaScript, Python, Project Management" oninput="updateCV()">
            </div>

            <!-- Work Experience -->
            <div class="section-title" data-section="experience">
                <span>Working Experience</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('experience')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('experience')">â†“</button>
                </div>
            </div>
            <div id="experienceContainer"></div>
            <button class="add-btn" onclick="addExperience()">+ Add Experience</button>
            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                <label style="font-size: 12px; font-weight: 700; margin-bottom: 8px; display: block;">Show Columns:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="expCol-position" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Position
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="expCol-company" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Company
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="expCol-location" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Location
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="expCol-period" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Period
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="expCol-details" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Details
                    </label>
                </div>
            </div>

            <!-- Certifications -->
            <div class="section-title" data-section="certification">
                <span>Certification</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('certification')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('certification')">â†“</button>
                </div>
            </div>
            <div id="certificationContainer"></div>
            <button class="add-btn" onclick="addCertification()">+ Add Certification</button>
            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                <label style="font-size: 12px; font-weight: 700; margin-bottom: 8px; display: block;">Show Columns:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="certCol-certification" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Certification
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="certCol-organization" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Organization
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="certCol-date" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Date
                    </label>
                </div>
            </div>

            <!-- Volunteer Work -->
            <div class="section-title" data-section="volunteer">
                <span>Volunteer Work</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('volunteer')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('volunteer')">â†“</button>
                </div>
            </div>
            <div id="volunteerContainer"></div>
            <button class="add-btn" onclick="addVolunteer()">+ Add Volunteer Work</button>
            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                <label style="font-size: 12px; font-weight: 700; margin-bottom: 8px; display: block;">Show Columns:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="volCol-role" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Role
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="volCol-organization" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Organization
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="volCol-date" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Date
                    </label>
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="volCol-description" checked onchange="updateCV()" style="width: auto; margin: 0;">
                        Description
                    </label>
                </div>
            </div>

            <!-- Referees -->
            <div class="section-title" data-section="referees">
                <span>Referees</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('referees')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('referees')">â†“</button>
                </div>
            </div>
            <div id="referenceContainer"></div>
            <button class="add-btn" onclick="addReference()">+ Add Referee</button>

            <!-- Custom Sections -->
            <div class="section-title">Custom Sections</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Add your own sections (e.g., Awards, Publications, Hobbies)</p>
            <div id="customSectionsContainer"></div>
            <button class="add-btn" onclick="addCustomSection()">+ Add Custom Section</button>

            <!-- Custom Section II -->
            <div class="section-title" data-section="custom2">
                <span>Custom Section II</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('custom2')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('custom2')">â†“</button>
                </div>
            </div>
            <div class="form-group">
                <label>Section Title</label>
                <input type="text" id="custom2SectionTitle" placeholder="e.g., Achievements, Projects" oninput="updateCV()">
            </div>
            <div class="form-group">
                <label>Title Header Name</label>
                <input type="text" id="custom2TitleHeader" placeholder="e.g., Title, Name, Achievement" value="Title" oninput="updateCustom2Labels(); updateCV()">
            </div>
            <div class="form-group">
                <label>Description Header Name</label>
                <input type="text" id="custom2DescHeader" placeholder="e.g., Description, Details, Summary" value="Description" oninput="updateCustom2Labels(); updateCV()">
            </div>
            <div id="custom2Container"></div>
            <button class="add-btn" onclick="addCustom2Entry()">+ Add Entry</button>

            <!-- Declaration -->
            <div class="section-title" data-section="declaration">
                <span>Declaration</span>
                <div class="section-controls">
                    <button class="move-btn" onclick="moveSectionUp('declaration')">â†‘</button>
                    <button class="move-btn" onclick="moveSectionDown('declaration')">â†“</button>
                </div>
            </div>
            <div class="form-group">
                <label>Declaration Text</label>
                <textarea id="declaration" oninput="updateCV()">I hereby declare that the information provided is true and correct to the best of my knowledge and belief.</textarea>
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="showSignature" onchange="updateCV()" style="width: auto; margin: 0;">
                <label for="showSignature" style="margin: 0; cursor: pointer;">Show Signature Line</label>
            </div>

            <!-- Export/Import Data -->
            <div class="section-title" style="margin-top: 30px;">Data Management</div>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Save your CV data for later editing or load previously saved data</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button onclick="exportData()" style="margin: 0; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);">
                    ðŸ’¾ Export Data
                </button>
                <button onclick="document.getElementById('importFile').click()" style="margin: 0; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                    ðŸ“ Import Data
                </button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

            <button onclick="downloadCV()" style="margin-top: 10px; width: 100%;">ðŸ“¥ Download CV (Print to PDF)</button>
        </div>

        <!-- CV Preview -->
        <div class="cv-preview">
            <div class="cv-document" id="cvDocument">
                <!-- Watermark -->
                <div class="cv-watermark" id="watermark"></div>
                
                <div class="cv-content-wrapper">
                    <!-- Main Title -->
                    <div class="cv-main-title">Curriculum Vitae (CV)</div>

                    <!-- Header with Photo and Contact -->
                    <div class="cv-header-section" id="headerSection">
                        <div class="cv-photo-container hidden" id="photoContainer">
                            <img id="photoPreview" class="cv-photo" style="display:none;">
                            <div class="photo-placeholder" id="photoPlaceholder">ðŸ‘¤</div>
                        </div>
                        <div class="cv-contact-info">
                            <div class="cv-name" id="displayName">Your Name</div>
                            <div class="cv-title-line" id="displayTitle" style="display: none;"></div>
                            <table class="cv-personal-details-table" id="personalDetailsTable"></table>
                        </div>
                    </div>

                    <!-- Professional Summary -->
                    <div class="cv-section" id="summarySection" style="display:none;">
                        <div class="cv-section-header-box"><span id="summaryNumber"></span> Professional Summary</div>
                        <table class="cv-unified-table">
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="cv-summary-text" id="displaySummary"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Sections Container - Will be dynamically ordered -->
                    <div id="sectionsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let experienceCount = 0;
        let educationCount = 0;
        let certificationCount = 0;
        let volunteerCount = 0;
        let referenceCount = 0;
        let customDetailCount = 0;
        let customSectionCount = 0;
        let custom2Count = 0;
        let photoData = null;

        // Store custom sections data
        const customSections = {};

        // Default section order
        let sectionOrder = ['education', 'skills', 'experience', 'certification', 'volunteer', 'referees', 'custom2', 'declaration'];

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    const photoPreview = document.getElementById('photoPreview');
                    const photoContainer = document.getElementById('photoContainer');
                    const photoPlaceholder = document.getElementById('photoPlaceholder');
                    
                    photoPreview.src = photoData;
                    photoPreview.style.display = 'block';
                    photoPlaceholder.style.display = 'none';
                    photoContainer.classList.remove('hidden');
                    updateCV();
                };
                reader.readAsDataURL(file);
            }
        }

        function moveSectionUp(sectionId) {
            const index = sectionOrder.indexOf(sectionId);
            if (index > 0) {
                [sectionOrder[index], sectionOrder[index - 1]] = [sectionOrder[index - 1], sectionOrder[index]];
                updateCV();
            }
        }

        function moveSectionDown(sectionId) {
            const index = sectionOrder.indexOf(sectionId);
            if (index < sectionOrder.length - 1 && index !== -1) {
                [sectionOrder[index], sectionOrder[index + 1]] = [sectionOrder[index + 1], sectionOrder[index]];
                updateCV();
            }
        }

        function addCustomDetail() {
            customDetailCount++;
            const container = document.getElementById('customDetailsContainer');
            const entry = document.createElement('div');
            entry.className = 'custom-detail-entry';
            entry.id = `customDetail-${customDetailCount}`;
            entry.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Header</label>
                    <input type="text" id="customHeader-${customDetailCount}" placeholder="e.g., License" oninput="updateCV()">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Detail</label>
                    <input type="text" id="customValue-${customDetailCount}" placeholder="e.g., Class A" oninput="updateCV()">
                </div>
                <button class="mini-remove-btn" onclick="removeEntry('customDetail-${customDetailCount}', updateCV)">âœ•</button>
            `;
            container.appendChild(entry);
        }

        function addExperience() {
            experienceCount++;
            const container = document.getElementById('experienceContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `experience-${experienceCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Experience #${experienceCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="expVisible-${experienceCount}" checked onchange="updateCV()">
                        <label for="expVisible-${experienceCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Job Title</label>
                    <input type="text" id="expTitle-${experienceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="expCompany-${experienceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="expLocation-${experienceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <input type="text" id="expDate-${experienceCount}" placeholder="Jan 2020 - Present" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Duties/Responsibilities</label>
                    <textarea id="expDesc-${experienceCount}" placeholder="- Achievement 1
- Achievement 2
- Achievement 3" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('experience-${experienceCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addEducation() {
            educationCount++;
            const container = document.getElementById('educationContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `education-${educationCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Education #${educationCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="eduVisible-${educationCount}" checked onchange="updateCV()">
                        <label for="eduVisible-${educationCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Qualification</label>
                    <input type="text" id="eduDegree-${educationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Institution</label>
                    <input type="text" id="eduInstitution-${educationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="eduLocation-${educationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="text" id="eduYear-${educationCount}" placeholder="2015 - 2019" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="eduDesc-${educationCount}" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('education-${educationCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addCertification() {
            certificationCount++;
            const container = document.getElementById('certificationContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `certification-${certificationCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Certification #${certificationCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="certVisible-${certificationCount}" checked onchange="updateCV()">
                        <label for="certVisible-${certificationCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Certification Name</label>
                    <input type="text" id="certName-${certificationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Organization</label>
                    <input type="text" id="certOrg-${certificationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" id="certDate-${certificationCount}" placeholder="Jan 2020" oninput="updateCV()">
                </div>
                <button class="remove-btn" onclick="removeEntry('certification-${certificationCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addVolunteer() {
            volunteerCount++;
            const container = document.getElementById('volunteerContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `volunteer-${volunteerCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Volunteer Work #${volunteerCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="volVisible-${volunteerCount}" checked onchange="updateCV()">
                        <label for="volVisible-${volunteerCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" id="volRole-${volunteerCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Organization</label>
                    <input type="text" id="volOrg-${volunteerCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" id="volDate-${volunteerCount}" placeholder="2020" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="volDesc-${volunteerCount}" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('volunteer-${volunteerCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addReference() {
            referenceCount++;
            const container = document.getElementById('referenceContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `reference-${referenceCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Reference #${referenceCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="refVisible-${referenceCount}" checked onchange="updateCV()">
                        <label for="refVisible-${referenceCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="refName-${referenceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Title/Position</label>
                    <input type="text" id="refTitle-${referenceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="refPhone-${referenceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="refEmail-${referenceCount}" oninput="updateCV()">
                </div>
                <button class="remove-btn" onclick="removeEntry('reference-${referenceCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addCustom2Entry() {
            custom2Count++;
            const titleHeader = document.getElementById('custom2TitleHeader').value || 'Title';
            const descHeader = document.getElementById('custom2DescHeader').value || 'Description';
            
            const container = document.getElementById('custom2Container');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `custom2-${custom2Count}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Entry #${custom2Count}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="custom2Visible-${custom2Count}" checked onchange="updateCV()">
                        <label for="custom2Visible-${custom2Count}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label id="custom2TitleLabel-${custom2Count}">${titleHeader}</label>
                    <input type="text" id="custom2Title-${custom2Count}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label id="custom2DescLabel-${custom2Count}">${descHeader}</label>
                    <textarea id="custom2Desc-${custom2Count}" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('custom2-${custom2Count}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function updateCustom2Labels() {
            const titleHeader = document.getElementById('custom2TitleHeader').value || 'Title';
            const descHeader = document.getElementById('custom2DescHeader').value || 'Description';
            
            for (let i = 1; i <= custom2Count + 100; i++) {
                const titleLabel = document.getElementById(`custom2TitleLabel-${i}`);
                const descLabel = document.getElementById(`custom2DescLabel-${i}`);
                
                if (titleLabel) titleLabel.textContent = titleHeader;
                if (descLabel) descLabel.textContent = descHeader;
            }
        }

        function addCustomSection() {
            customSectionCount++;
            const sectionId = `customSection-${customSectionCount}`;
            customSections[sectionId] = { entries: [], entryCount: 0 };
            
            // Add to section order (before referees)
            const refIndex = sectionOrder.indexOf('referees');
            if (refIndex !== -1) {
                sectionOrder.splice(refIndex, 0, sectionId);
            } else {
                // If no referees, try before declaration
                const declIndex = sectionOrder.indexOf('declaration');
                if (declIndex !== -1) {
                    sectionOrder.splice(declIndex, 0, sectionId);
                } else {
                    sectionOrder.push(sectionId);
                }
            }
            
            const container = document.getElementById('customSectionsContainer');
            const section = document.createElement('div');
            section.className = 'custom-section-container';
            section.id = sectionId;
            section.innerHTML = `
                <div class="form-group">
                    <label>Section Title</label>
                    <input type="text" class="custom-section-title-input" id="${sectionId}-title" placeholder="e.g., Awards, Publications, Hobbies" oninput="updateCV()">
                </div>
                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <button class="move-btn" onclick="moveSectionUp('${sectionId}')">â†‘ Move Up</button>
                    <button class="move-btn" onclick="moveSectionDown('${sectionId}')">â†“ Move Down</button>
                </div>
                <div id="${sectionId}-entries"></div>
                <button class="add-btn" onclick="addCustomSectionEntry('${sectionId}')">+ Add Entry</button>
                <button class="remove-btn" onclick="removeCustomSection('${sectionId}')">Remove Section</button>
            `;
            container.appendChild(section);
        }

        function addCustomSectionEntry(sectionId) {
            const section = customSections[sectionId];
            section.entryCount++;
            const entryId = `${sectionId}-entry-${section.entryCount}`;
            
            const container = document.getElementById(`${sectionId}-entries`);
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = entryId;
            entry.innerHTML = `
                <div class="form-group">
                    <label>Title/Name</label>
                    <input type="text" id="${entryId}-name" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Subtitle (Optional)</label>
                    <input type="text" id="${entryId}-subtitle" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date (Optional)</label>
                    <input type="text" id="${entryId}-date" placeholder="2020" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="${entryId}-description" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeCustomSectionEntry('${sectionId}', '${entryId}')">Remove Entry</button>
            `;
            container.appendChild(entry);
        }

        function removeCustomSectionEntry(sectionId, entryId) {
            document.getElementById(entryId).remove();
            updateCV();
        }

        function removeCustomSection(sectionId) {
            document.getElementById(sectionId).remove();
            delete customSections[sectionId];
            const index = sectionOrder.indexOf(sectionId);
            if (index !== -1) {
                sectionOrder.splice(index, 1);
            }
            updateCV();
        }

        function removeEntry(id, callback) {
            document.getElementById(id).remove();
            if (callback) callback();
        }

        function formatBullets(text) {
            if (!text) return '';
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return '';
            
            const hasBullets = lines.some(line => line.trim().startsWith('-') || line.trim().startsWith('â€¢'));
            
            if (hasBullets) {
                const formatted = lines.map(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('-') || trimmed.startsWith('â€¢')) {
                        return '<li>' + trimmed.substring(1).trim() + '</li>';
                    }
                    return '<li>' + trimmed + '</li>';
                }).join('');
                return '<ul>' + formatted + '</ul>';
            }
            
            return '<p>' + lines.join('<br>') + '</p>';
        }

        function capitalizeText(text) {
            if (!text) return '';
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        function createTableWithHeaders(items, columns, visibleColumns = null) {
            if (items.length === 0) return '';
            
            // Filter columns if visibleColumns is provided
            const displayColumns = visibleColumns ? columns.filter(col => visibleColumns.includes(col)) : columns;
            
            if (displayColumns.length === 0) return '';
            
            // Create header row
            let headerRow = '<tr>';
            displayColumns.forEach(col => {
                headerRow += `<th>${col}</th>`;
            });
            headerRow += '</tr>';
            
            // Create data rows
            let dataRows = '';
            items.forEach(item => {
                dataRows += '<tr>';
                displayColumns.forEach(col => {
                    const value = item[col] || '';
                    dataRows += `<td>${value}</td>`;
                });
                dataRows += '</tr>';
            });
            
            return `<thead>${headerRow}</thead><tbody>${dataRows}</tbody>`;
        }

        function applyTextCase(text) {
            if (!text) return '';
            const textCase = document.getElementById('textCase').value;
            
            switch(textCase) {
                case 'uppercase':
                    return text.toUpperCase();
                case 'lowercase':
                    return text.toLowerCase();
                case 'capitalize':
                    // Sentence case
                    return text;
                case 'none':
                    return text;
                default:
                    return text;
            }
        }

        function updateCV() {
            // Apply text case class to CV document
            const cvDocument = document.getElementById('cvDocument');
            const textCase = document.getElementById('textCase').value;
            cvDocument.className = 'cv-document text-' + textCase;
            
            // Update name and watermark
            const name = document.getElementById('fullName').value || 'Your Name';
            document.getElementById('displayName').textContent = name;
            document.getElementById('watermark').textContent = name;

            // Update photo visibility
            const headerSection = document.getElementById('headerSection');
            const photoContainer = document.getElementById('photoContainer');
            if (!photoData) {
                photoContainer.classList.add('hidden');
                headerSection.classList.add('no-photo');
            } else {
                photoContainer.classList.remove('hidden');
                headerSection.classList.remove('no-photo');
            }

            // Update personal details table in specific order
            const personalDetailsTable = document.getElementById('personalDetailsTable');
            personalDetailsTable.innerHTML = '';

            const dob = document.getElementById('dob').value;
            const gender = document.getElementById('gender').value;
            const nationality = document.getElementById('nationality').value;
            const language = document.getElementById('language').value;
            const maritalStatus = document.getElementById('maritalStatus').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;

            if (dob) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Date Of Birth:</td><td>${dob}</td>`;
            }
            if (gender) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Sex/Gender:</td><td>${gender}</td>`;
            }
            if (nationality) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Nationality:</td><td>${nationality}</td>`;
            }
            if (language) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Language:</td><td>${language}</td>`;
            }
            if (maritalStatus) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Marital Status:</td><td>${maritalStatus}</td>`;
            }
            if (phone) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Phone Number:</td><td>${phone}</td>`;
            }
            if (email) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>E-mail:</td><td>${email}</td>`;
            }
            if (address) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Address:</td><td>${address}</td>`;
            }

            // Add custom details
            for (let i = 1; i <= customDetailCount + 100; i++) {
                const headerEl = document.getElementById(`customHeader-${i}`);
                const valueEl = document.getElementById(`customValue-${i}`);
                if (headerEl && valueEl && headerEl.value && valueEl.value) {
                    const row = personalDetailsTable.insertRow();
                    row.innerHTML = `<td>${headerEl.value}:</td><td>${valueEl.value}</td>`;
                }
            }

            // Update summary
            const summary = document.getElementById('summary').value;
            if (summary) {
                document.getElementById('summarySection').style.display = 'block';
                document.getElementById('displaySummary').textContent = summary;
            } else {
                document.getElementById('summarySection').style.display = 'none';
            }

            // Build sections based on order
            const sectionsContainer = document.getElementById('sectionsContainer');
            sectionsContainer.innerHTML = '';
            
            let sectionNumber = 1;

            sectionOrder.forEach(sectionId => {
                if (sectionId === 'education') {
                    const eduContainer = document.createElement('div');
                    const education = [];
                    
                    // Get visible columns
                    const visibleCols = [];
                    if (document.getElementById('eduCol-qualification').checked) visibleCols.push('Qualification');
                    if (document.getElementById('eduCol-institution').checked) visibleCols.push('Institution');
                    if (document.getElementById('eduCol-location').checked) visibleCols.push('Location');
                    if (document.getElementById('eduCol-period').checked) visibleCols.push('Period');
                    if (document.getElementById('eduCol-details').checked) visibleCols.push('Details');
                    
                    for (let i = 1; i <= educationCount + 100; i++) {
                        const degreeEl = document.getElementById(`eduDegree-${i}`);
                        const visibleCheckbox = document.getElementById(`eduVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (degreeEl && degreeEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const institution = document.getElementById(`eduInstitution-${i}`).value;
                            const location = document.getElementById(`eduLocation-${i}`).value;
                            const year = document.getElementById(`eduYear-${i}`).value;
                            const desc = document.getElementById(`eduDesc-${i}`).value;
                            
                            const item = {
                                'Qualification': degreeEl.value,
                                'Institution': institution,
                                'Location': location,
                                'Period': year,
                                'Details': desc
                            };
                            
                            education.push(item);
                        }
                    }
                    if (education.length > 0 && visibleCols.length > 0) {
                        eduContainer.className = 'cv-section';
                        eduContainer.innerHTML = `
                            <div class="cv-section-header-box">${sectionNumber}. Education Background</div>
                            <table class="cv-unified-table">
                                ${createTableWithHeaders(education, ['Qualification', 'Institution', 'Location', 'Period', 'Details'], visibleCols)}
                            </table>
                        `;
                        sectionsContainer.appendChild(eduContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'skills') {
                    const skills = document.getElementById('skills').value;
                    if (skills) {
                        const skillsArray = skills.split(',').map(s => s.trim()).filter(s => s);
                        if (skillsArray.length > 0) {
                            const skillsContainer = document.createElement('div');
                            skillsContainer.className = 'cv-section';
                            
                            let skillsHtml = '<div class="cv-skills-grid">';
                            skillsArray.forEach(skill => {
                                skillsHtml += `<div class="cv-skill-item">${skill}</div>`;
                            });
                            skillsHtml += '</div>';
                            
                            skillsContainer.innerHTML = `
                                <div class="cv-section-header-box">${sectionNumber}. Skills</div>
                                <table class="cv-skills-table">
                                    <tbody>
                                        <tr>
                                            <td>${skillsHtml}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                            sectionsContainer.appendChild(skillsContainer);
                            sectionNumber++;
                        }
                    }
                } else if (sectionId === 'experience') {
                    const expContainer = document.createElement('div');
                    const experiences = [];
                    
                    // Get visible columns (excluding Details as it will be shown separately)
                    const visibleCols = [];
                    if (document.getElementById('expCol-position').checked) visibleCols.push('Position');
                    if (document.getElementById('expCol-company').checked) visibleCols.push('Company');
                    if (document.getElementById('expCol-location').checked) visibleCols.push('Location');
                    if (document.getElementById('expCol-period').checked) visibleCols.push('Period');
                    
                    for (let i = 1; i <= experienceCount + 100; i++) {
                        const titleEl = document.getElementById(`expTitle-${i}`);
                        const visibleCheckbox = document.getElementById(`expVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (titleEl && titleEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const company = document.getElementById(`expCompany-${i}`).value;
                            const location = document.getElementById(`expLocation-${i}`).value;
                            const date = document.getElementById(`expDate-${i}`).value;
                            const desc = document.getElementById(`expDesc-${i}`).value;
                            
                            const item = {
                                'Position': titleEl.value,
                                'Company': company,
                                'Location': location,
                                'Period': date,
                                'Duties': desc ? formatBullets(desc) : ''
                            };
                            
                            experiences.push(item);
                        }
                    }
                    if (experiences.length > 0 && visibleCols.length > 0) {
                        expContainer.className = 'cv-section';
                        let expHtml = `
                            <div class="cv-section-header-box">${sectionNumber}. Working Experience</div>
                        `;
                        
                        // Create each experience entry with table and duties below
                        experiences.forEach((exp, index) => {
                            // Create table for this experience
                            const tableData = [exp];
                            expHtml += `
                                <table class="cv-unified-table" style="margin-bottom: 5px;">
                                    ${createTableWithHeaders(tableData, ['Position', 'Company', 'Location', 'Period'], visibleCols)}
                                </table>
                            `;
                            
                            // Add Duties/Responsibilities section below if Details column is visible and duties exist
                            if (document.getElementById('expCol-details').checked && exp.Duties) {
                                expHtml += `
                                    <div class="cv-duties-section">
                                        <div class="cv-duties-label">Duties/Responsibilities:</div>
                                        <div class="cv-duties-content">${exp.Duties}</div>
                                    </div>
                                `;
                            }
                            
                            // Add spacing between entries except for the last one
                            if (index < experiences.length - 1) {
                                expHtml += `<div style="margin-bottom: 20px;"></div>`;
                            }
                        });
                        
                        expContainer.innerHTML = expHtml;
                        sectionsContainer.appendChild(expContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'certification') {
                    const certContainer = document.createElement('div');
                    const certifications = [];
                    
                    // Get visible columns
                    const visibleCols = [];
                    if (document.getElementById('certCol-certification').checked) visibleCols.push('Certification');
                    if (document.getElementById('certCol-organization').checked) visibleCols.push('Organization');
                    if (document.getElementById('certCol-date').checked) visibleCols.push('Date');
                    
                    for (let i = 1; i <= certificationCount + 100; i++) {
                        const nameEl = document.getElementById(`certName-${i}`);
                        const visibleCheckbox = document.getElementById(`certVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (nameEl && nameEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const org = document.getElementById(`certOrg-${i}`).value;
                            const date = document.getElementById(`certDate-${i}`).value;
                            
                            const item = {
                                'Certification': nameEl.value,
                                'Organization': org,
                                'Date': date
                            };
                            
                            certifications.push(item);
                        }
                    }
                    if (certifications.length > 0 && visibleCols.length > 0) {
                        certContainer.className = 'cv-section';
                        certContainer.innerHTML = `
                            <div class="cv-section-header-box">${sectionNumber}. Certification</div>
                            <table class="cv-unified-table">
                                ${createTableWithHeaders(certifications, ['Certification', 'Organization', 'Date'], visibleCols)}
                            </table>
                        `;
                        sectionsContainer.appendChild(certContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'volunteer') {
                    const volContainer = document.createElement('div');
                    const volunteer = [];
                    
                    // Get visible columns
                    const visibleCols = [];
                    if (document.getElementById('volCol-role').checked) visibleCols.push('Role');
                    if (document.getElementById('volCol-organization').checked) visibleCols.push('Organization');
                    if (document.getElementById('volCol-date').checked) visibleCols.push('Date');
                    if (document.getElementById('volCol-description').checked) visibleCols.push('Description');
                    
                    for (let i = 1; i <= volunteerCount + 100; i++) {
                        const roleEl = document.getElementById(`volRole-${i}`);
                        const visibleCheckbox = document.getElementById(`volVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (roleEl && roleEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const org = document.getElementById(`volOrg-${i}`).value;
                            const date = document.getElementById(`volDate-${i}`).value;
                            const desc = document.getElementById(`volDesc-${i}`).value;
                            
                            const item = {
                                'Role': roleEl.value,
                                'Organization': org,
                                'Date': date,
                                'Description': desc
                            };
                            
                            volunteer.push(item);
                        }
                    }
                    if (volunteer.length > 0 && visibleCols.length > 0) {
                        volContainer.className = 'cv-section';
                        volContainer.innerHTML = `
                            <div class="cv-section-header-box">${sectionNumber}. Volunteer Work</div>
                            <table class="cv-unified-table">
                                ${createTableWithHeaders(volunteer, ['Role', 'Organization', 'Date', 'Description'], visibleCols)}
                            </table>
                        `;
                        sectionsContainer.appendChild(volContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'referees') {
                    const refContainer = document.createElement('div');
                    const references = [];
                    
                    for (let i = 1; i <= referenceCount + 100; i++) {
                        const nameEl = document.getElementById(`refName-${i}`);
                        const visibleCheckbox = document.getElementById(`refVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (nameEl && nameEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const title = document.getElementById(`refTitle-${i}`).value;
                            const phone = document.getElementById(`refPhone-${i}`).value;
                            const email = document.getElementById(`refEmail-${i}`).value;
                            
                            const item = {
                                'Name': nameEl.value,
                                'Title': title,
                                'Phone': phone,
                                'Email': email
                            };
                            
                            references.push(item);
                        }
                    }
                    if (references.length > 0) {
                        refContainer.className = 'cv-section';
                        let refHtml = `<div class="cv-section-header-box">${sectionNumber}. Referees</div>`;
                        
                        references.forEach(ref => {
                            refHtml += `
                                <div class="cv-referee-item">
                                    <div class="cv-referee-name">${ref.Name}</div>
                                    ${ref.Title ? `<div class="cv-referee-detail"><strong>Title:</strong> ${ref.Title}</div>` : ''}
                                    ${ref.Phone ? `<div class="cv-referee-detail"><strong>Phone:</strong> ${ref.Phone}</div>` : ''}
                                    ${ref.Email ? `<div class="cv-referee-detail"><strong>Email:</strong> ${ref.Email}</div>` : ''}
                                </div>
                            `;
                        });
                        
                        refContainer.innerHTML = refHtml;
                        sectionsContainer.appendChild(refContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'custom2') {
                    const custom2Container = document.createElement('div');
                    const custom2Entries = [];
                    
                    const sectionTitle = document.getElementById('custom2SectionTitle').value;
                    const titleHeader = document.getElementById('custom2TitleHeader').value || 'Title';
                    const descHeader = document.getElementById('custom2DescHeader').value || 'Description';
                    
                    for (let i = 1; i <= custom2Count + 100; i++) {
                        const titleEl = document.getElementById(`custom2Title-${i}`);
                        const visibleCheckbox = document.getElementById(`custom2Visible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (titleEl && titleEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const desc = document.getElementById(`custom2Desc-${i}`).value;
                            
                            const item = {
                                'Title': titleEl.value,
                                'Description': desc
                            };
                            
                            custom2Entries.push(item);
                        }
                    }
                    
                    if (custom2Entries.length > 0 && sectionTitle) {
                        custom2Container.className = 'cv-section';
                        let custom2Html = `<div class="cv-section-header-box">${sectionNumber}. ${sectionTitle}</div>`;
                        
                        custom2Entries.forEach(entry => {
                            custom2Html += `
                                <div class="cv-custom2-item">
                                    <div class="cv-custom2-title">${titleHeader}: ${entry.Title}</div>
                                    ${entry.Description ? `<div class="cv-custom2-description">${descHeader}: ${entry.Description}</div>` : ''}
                                </div>
                            `;
                        });
                        
                        custom2Container.innerHTML = custom2Html;
                        sectionsContainer.appendChild(custom2Container);
                        sectionNumber++;
                    }
                } else if (sectionId === 'declaration') {
                    const declaration = document.getElementById('declaration').value;
                    const showSignature = document.getElementById('showSignature').checked;
                    
                    if (declaration) {
                        const declarationContainer = document.createElement('div');
                        declarationContainer.className = 'cv-section';
                        
                        let declarationHtml = `
                            <div class="cv-section-header-box">${sectionNumber}. Declaration</div>
                            <table class="cv-unified-table">
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="cv-declaration-text">${declaration}</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                        
                        if (showSignature) {
                            declarationHtml += `
                                <div class="cv-signature-container">
                                    <div class="cv-signature-label">Signature</div>
                                    <div class="cv-signature-line"></div>
                                </div>
                            `;
                        }
                        
                        declarationContainer.innerHTML = declarationHtml;
                        sectionsContainer.appendChild(declarationContainer);
                        sectionNumber++;
                    }
                } else if (customSections[sectionId]) {
                    const titleEl = document.getElementById(`${sectionId}-title`);
                    if (titleEl && titleEl.value) {
                        const entries = [];
                        const section = customSections[sectionId];
                        
                        for (let i = 1; i <= section.entryCount + 100; i++) {
                            const entryId = `${sectionId}-entry-${i}`;
                            const nameEl = document.getElementById(`${entryId}-name`);
                            
                            if (nameEl && nameEl.value) {
                                const subtitle = document.getElementById(`${entryId}-subtitle`).value;
                                const date = document.getElementById(`${entryId}-date`).value;
                                const description = document.getElementById(`${entryId}-description`).value;
                                
                                const item = {
                                    'Title': nameEl.value,
                                    'Subtitle': subtitle,
                                    'Date': date,
                                    'Description': description
                                };
                                
                                entries.push(item);
                            }
                        }
                        
                        if (entries.length > 0) {
                            const customContainer = document.createElement('div');
                            customContainer.className = 'cv-section';
                            customContainer.innerHTML = `
                                <div class="cv-section-header-box">${sectionNumber}. ${titleEl.value}</div>
                                <table class="cv-unified-table">
                                    ${createTableWithHeaders(entries, ['Title', 'Subtitle', 'Date', 'Description'])}
                                </table>
                            `;
                            sectionsContainer.appendChild(customContainer);
                            sectionNumber++;
                        }
                    }
                }
            });
        }

        function downloadCV() {
            window.print();
        }

        function exportData() {
            const data = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                
                // Counters
                counters: {
                    experienceCount,
                    educationCount,
                    certificationCount,
                    volunteerCount,
                    referenceCount,
                    customDetailCount,
                    customSectionCount,
                    custom2Count
                },
                
                // Section order
                sectionOrder: [...sectionOrder],
                
                // Photo data
                photoData: photoData,
                
                // Basic personal info
                personalInfo: {
                    fullName: document.getElementById('fullName').value,
                    jobTitle: document.getElementById('jobTitle').value,
                    dob: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    language: document.getElementById('language').value,
                    maritalStatus: document.getElementById('maritalStatus').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    textCase: document.getElementById('textCase').value
                },
                
                // Custom details
                customDetails: [],
                
                // Professional summary
                summary: document.getElementById('summary').value,
                
                // Skills
                skills: document.getElementById('skills').value,
                
                // Column visibility
                columnVisibility: {
                    education: {
                        qualification: document.getElementById('eduCol-qualification').checked,
                        institution: document.getElementById('eduCol-institution').checked,
                        location: document.getElementById('eduCol-location').checked,
                        period: document.getElementById('eduCol-period').checked,
                        details: document.getElementById('eduCol-details').checked
                    },
                    experience: {
                        position: document.getElementById('expCol-position').checked,
                        company: document.getElementById('expCol-company').checked,
                        location: document.getElementById('expCol-location').checked,
                        period: document.getElementById('expCol-period').checked,
                        details: document.getElementById('expCol-details').checked
                    },
                    certification: {
                        certification: document.getElementById('certCol-certification').checked,
                        organization: document.getElementById('certCol-organization').checked,
                        date: document.getElementById('certCol-date').checked
                    },
                    volunteer: {
                        role: document.getElementById('volCol-role').checked,
                        organization: document.getElementById('volCol-organization').checked,
                        date: document.getElementById('volCol-date').checked,
                        description: document.getElementById('volCol-description').checked
                    }
                },
                
                // Education entries
                education: [],
                
                // Experience entries
                experience: [],
                
                // Certification entries
                certifications: [],
                
                // Volunteer entries
                volunteer: [],
                
                // Reference entries
                references: [],
                
                // Custom2 entries
                custom2: {
                    sectionTitle: document.getElementById('custom2SectionTitle').value,
                    titleHeader: document.getElementById('custom2TitleHeader').value,
                    descHeader: document.getElementById('custom2DescHeader').value,
                    entries: []
                },
                
                // Custom sections
                customSections: {},
                
                // Declaration
                declaration: {
                    text: document.getElementById('declaration').value,
                    showSignature: document.getElementById('showSignature').checked
                }
            };
            
            // Collect custom details
            for (let i = 1; i <= customDetailCount + 100; i++) {
                const labelEl = document.getElementById(`customLabel-${i}`);
                if (labelEl && labelEl.value) {
                    data.customDetails.push({
                        label: labelEl.value,
                        value: document.getElementById(`customValue-${i}`).value
                    });
                }
            }
            
            // Collect education entries
            for (let i = 1; i <= educationCount + 100; i++) {
                const degreeEl = document.getElementById(`eduDegree-${i}`);
                const visibleEl = document.getElementById(`eduVisible-${i}`);
                if (degreeEl) {
                    data.education.push({
                        degree: degreeEl.value,
                        institution: document.getElementById(`eduInstitution-${i}`)?.value || '',
                        location: document.getElementById(`eduLocation-${i}`)?.value || '',
                        year: document.getElementById(`eduYear-${i}`)?.value || '',
                        description: document.getElementById(`eduDesc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect experience entries
            for (let i = 1; i <= experienceCount + 100; i++) {
                const titleEl = document.getElementById(`expTitle-${i}`);
                const visibleEl = document.getElementById(`expVisible-${i}`);
                if (titleEl) {
                    data.experience.push({
                        title: titleEl.value,
                        company: document.getElementById(`expCompany-${i}`)?.value || '',
                        location: document.getElementById(`expLocation-${i}`)?.value || '',
                        date: document.getElementById(`expDate-${i}`)?.value || '',
                        description: document.getElementById(`expDesc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect certification entries
            for (let i = 1; i <= certificationCount + 100; i++) {
                const nameEl = document.getElementById(`certName-${i}`);
                const visibleEl = document.getElementById(`certVisible-${i}`);
                if (nameEl) {
                    data.certifications.push({
                        name: nameEl.value,
                        organization: document.getElementById(`certOrg-${i}`)?.value || '',
                        date: document.getElementById(`certDate-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect volunteer entries
            for (let i = 1; i <= volunteerCount + 100; i++) {
                const roleEl = document.getElementById(`volRole-${i}`);
                const visibleEl = document.getElementById(`volVisible-${i}`);
                if (roleEl) {
                    data.volunteer.push({
                        role: roleEl.value,
                        organization: document.getElementById(`volOrg-${i}`)?.value || '',
                        date: document.getElementById(`volDate-${i}`)?.value || '',
                        description: document.getElementById(`volDesc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect reference entries
            for (let i = 1; i <= referenceCount + 100; i++) {
                const nameEl = document.getElementById(`refName-${i}`);
                const visibleEl = document.getElementById(`refVisible-${i}`);
                if (nameEl) {
                    data.references.push({
                        name: nameEl.value,
                        title: document.getElementById(`refTitle-${i}`)?.value || '',
                        phone: document.getElementById(`refPhone-${i}`)?.value || '',
                        email: document.getElementById(`refEmail-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect custom2 entries
            for (let i = 1; i <= custom2Count + 100; i++) {
                const titleEl = document.getElementById(`custom2Title-${i}`);
                const visibleEl = document.getElementById(`custom2Visible-${i}`);
                if (titleEl) {
                    data.custom2.entries.push({
                        title: titleEl.value,
                        description: document.getElementById(`custom2Desc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect custom sections
            for (const sectionId in customSections) {
                const titleEl = document.getElementById(`${sectionId}-title`);
                if (titleEl) {
                    data.customSections[sectionId] = {
                        title: titleEl.value,
                        entryCount: customSections[sectionId].entryCount,
                        entries: []
                    };
                    
                    for (let i = 1; i <= customSections[sectionId].entryCount + 100; i++) {
                        const entryId = `${sectionId}-entry-${i}`;
                        const nameEl = document.getElementById(`${entryId}-name`);
                        if (nameEl) {
                            data.customSections[sectionId].entries.push({
                                name: nameEl.value,
                                subtitle: document.getElementById(`${entryId}-subtitle`)?.value || '',
                                date: document.getElementById(`${entryId}-date`)?.value || '',
                                description: document.getElementById(`${entryId}-description`)?.value || ''
                            });
                        }
                    }
                }
            }
            
            // Create download
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const fileName = `CV_Data_${data.personalInfo.fullName || 'Export'}_${new Date().toISOString().split('T')[0]}.json`;
            link.download = fileName.replace(/[^a-z0-9._-]/gi, '_');
            link.click();
            URL.revokeObjectURL(url);
            
            alert('CV data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Clear existing data
                    document.getElementById('educationContainer').innerHTML = '';
                    document.getElementById('experienceContainer').innerHTML = '';
                    document.getElementById('certificationContainer').innerHTML = '';
                    document.getElementById('volunteerContainer').innerHTML = '';
                    document.getElementById('referenceContainer').innerHTML = '';
                    document.getElementById('customDetailsContainer').innerHTML = '';
                    document.getElementById('custom2Container').innerHTML = '';
                    document.getElementById('customSectionsContainer').innerHTML = '';
                    
                    // Reset counters
                    experienceCount = 0;
                    educationCount = 0;
                    certificationCount = 0;
                    volunteerCount = 0;
                    referenceCount = 0;
                    customDetailCount = 0;
                    customSectionCount = 0;
                    custom2Count = 0;
                    
                    // Clear custom sections
                    for (const key in customSections) {
                        delete customSections[key];
                    }
                    
                    // Note: Section order is not restored as custom sections get new IDs
                    // Users can reorder sections after import using the up/down arrows
                    
                    // Restore photo
                    if (data.photoData) {
                        photoData = data.photoData;
                        const photoPreview = document.getElementById('photoPreview');
                        const photoPlaceholder = document.getElementById('photoPlaceholder');
                        photoPreview.src = photoData;
                        photoPreview.style.display = 'block';
                        photoPlaceholder.style.display = 'none';
                    }
                    
                    // Restore basic personal info
                    if (data.personalInfo) {
                        document.getElementById('fullName').value = data.personalInfo.fullName || '';
                        document.getElementById('jobTitle').value = data.personalInfo.jobTitle || '';
                        document.getElementById('dob').value = data.personalInfo.dob || '';
                        document.getElementById('gender').value = data.personalInfo.gender || '';
                        document.getElementById('nationality').value = data.personalInfo.nationality || '';
                        document.getElementById('language').value = data.personalInfo.language || '';
                        document.getElementById('maritalStatus').value = data.personalInfo.maritalStatus || '';
                        document.getElementById('phone').value = data.personalInfo.phone || '';
                        document.getElementById('email').value = data.personalInfo.email || '';
                        document.getElementById('address').value = data.personalInfo.address || '';
                        document.getElementById('textCase').value = data.personalInfo.textCase || 'none';
                    }
                    
                    // Restore custom details
                    if (data.customDetails) {
                        data.customDetails.forEach(detail => {
                            addCustomDetail();
                            document.getElementById(`customLabel-${customDetailCount}`).value = detail.label;
                            document.getElementById(`customValue-${customDetailCount}`).value = detail.value;
                        });
                    }
                    
                    // Restore summary
                    document.getElementById('summary').value = data.summary || '';
                    
                    // Restore skills
                    document.getElementById('skills').value = data.skills || '';
                    
                    // Restore column visibility
                    if (data.columnVisibility) {
                        if (data.columnVisibility.education) {
                            document.getElementById('eduCol-qualification').checked = data.columnVisibility.education.qualification !== false;
                            document.getElementById('eduCol-institution').checked = data.columnVisibility.education.institution !== false;
                            document.getElementById('eduCol-location').checked = data.columnVisibility.education.location !== false;
                            document.getElementById('eduCol-period').checked = data.columnVisibility.education.period !== false;
                            document.getElementById('eduCol-details').checked = data.columnVisibility.education.details !== false;
                        }
                        if (data.columnVisibility.experience) {
                            document.getElementById('expCol-position').checked = data.columnVisibility.experience.position !== false;
                            document.getElementById('expCol-company').checked = data.columnVisibility.experience.company !== false;
                            document.getElementById('expCol-location').checked = data.columnVisibility.experience.location !== false;
                            document.getElementById('expCol-period').checked = data.columnVisibility.experience.period !== false;
                            document.getElementById('expCol-details').checked = data.columnVisibility.experience.details !== false;
                        }
                        if (data.columnVisibility.certification) {
                            document.getElementById('certCol-certification').checked = data.columnVisibility.certification.certification !== false;
                            document.getElementById('certCol-organization').checked = data.columnVisibility.certification.organization !== false;
                            document.getElementById('certCol-date').checked = data.columnVisibility.certification.date !== false;
                        }
                        if (data.columnVisibility.volunteer) {
                            document.getElementById('volCol-role').checked = data.columnVisibility.volunteer.role !== false;
                            document.getElementById('volCol-organization').checked = data.columnVisibility.volunteer.organization !== false;
                            document.getElementById('volCol-date').checked = data.columnVisibility.volunteer.date !== false;
                            document.getElementById('volCol-description').checked = data.columnVisibility.volunteer.description !== false;
                        }
                    }
                    
                    // Restore education entries
                    if (data.education) {
                        data.education.forEach(edu => {
                            addEducation();
                            document.getElementById(`eduDegree-${educationCount}`).value = edu.degree || '';
                            document.getElementById(`eduInstitution-${educationCount}`).value = edu.institution || '';
                            document.getElementById(`eduLocation-${educationCount}`).value = edu.location || '';
                            document.getElementById(`eduYear-${educationCount}`).value = edu.year || '';
                            document.getElementById(`eduDesc-${educationCount}`).value = edu.description || '';
                            const visibleEl = document.getElementById(`eduVisible-${educationCount}`);
                            if (visibleEl) visibleEl.checked = edu.visible !== false;
                        });
                    }
                    
                    // Restore experience entries
                    if (data.experience) {
                        data.experience.forEach(exp => {
                            addExperience();
                            document.getElementById(`expTitle-${experienceCount}`).value = exp.title || '';
                            document.getElementById(`expCompany-${experienceCount}`).value = exp.company || '';
                            document.getElementById(`expLocation-${experienceCount}`).value = exp.location || '';
                            document.getElementById(`expDate-${experienceCount}`).value = exp.date || '';
                            document.getElementById(`expDesc-${experienceCount}`).value = exp.description || '';
                            const visibleEl = document.getElementById(`expVisible-${experienceCount}`);
                            if (visibleEl) visibleEl.checked = exp.visible !== false;
                        });
                    }
                    
                    // Restore certification entries
                    if (data.certifications) {
                        data.certifications.forEach(cert => {
                            addCertification();
                            document.getElementById(`certName-${certificationCount}`).value = cert.name || '';
                            document.getElementById(`certOrg-${certificationCount}`).value = cert.organization || '';
                            document.getElementById(`certDate-${certificationCount}`).value = cert.date || '';
                            const visibleEl = document.getElementById(`certVisible-${certificationCount}`);
                            if (visibleEl) visibleEl.checked = cert.visible !== false;
                        });
                    }
                    
                    // Restore volunteer entries
                    if (data.volunteer) {
                        data.volunteer.forEach(vol => {
                            addVolunteer();
                            document.getElementById(`volRole-${volunteerCount}`).value = vol.role || '';
                            document.getElementById(`volOrg-${volunteerCount}`).value = vol.organization || '';
                            document.getElementById(`volDate-${volunteerCount}`).value = vol.date || '';
                            document.getElementById(`volDesc-${volunteerCount}`).value = vol.description || '';
                            const visibleEl = document.getElementById(`volVisible-${volunteerCount}`);
                            if (visibleEl) visibleEl.checked = vol.visible !== false;
                        });
                    }
                    
                    // Restore reference entries
                    if (data.references) {
                        data.references.forEach(ref => {
                            addReference();
                            document.getElementById(`refName-${referenceCount}`).value = ref.name || '';
                            document.getElementById(`refTitle-${referenceCount}`).value = ref.title || '';
                            document.getElementById(`refPhone-${referenceCount}`).value = ref.phone || '';
                            document.getElementById(`refEmail-${referenceCount}`).value = ref.email || '';
                            const visibleEl = document.getElementById(`refVisible-${referenceCount}`);
                            if (visibleEl) visibleEl.checked = ref.visible !== false;
                        });
                    }
                    
                    // Restore custom2
                    if (data.custom2) {
                        document.getElementById('custom2SectionTitle').value = data.custom2.sectionTitle || '';
                        document.getElementById('custom2TitleHeader').value = data.custom2.titleHeader || 'Title';
                        document.getElementById('custom2DescHeader').value = data.custom2.descHeader || 'Description';
                        
                        if (data.custom2.entries) {
                            data.custom2.entries.forEach(entry => {
                                addCustom2Entry();
                                document.getElementById(`custom2Title-${custom2Count}`).value = entry.title || '';
                                document.getElementById(`custom2Desc-${custom2Count}`).value = entry.description || '';
                                const visibleEl = document.getElementById(`custom2Visible-${custom2Count}`);
                                if (visibleEl) visibleEl.checked = entry.visible !== false;
                            });
                        }
                        
                        updateCustom2Labels();
                    }
                    
                    // Restore custom sections
                    if (data.customSections) {
                        const keys = Object.keys(data.customSections);
                        keys.forEach((originalSectionId, idx) => {
                            const sectionData = data.customSections[originalSectionId];
                            
                            // Add a new custom section
                            customSectionCount++;
                            const sectionId = `customSection-${customSectionCount}`;
                            customSections[sectionId] = { entries: [], entryCount: 0 };
                            
                            // Add to section order (before referees)
                            const refIndex = sectionOrder.indexOf('referees');
                            if (refIndex !== -1) {
                                sectionOrder.splice(refIndex, 0, sectionId);
                            } else {
                                const declIndex = sectionOrder.indexOf('declaration');
                                if (declIndex !== -1) {
                                    sectionOrder.splice(declIndex, 0, sectionId);
                                } else {
                                    sectionOrder.push(sectionId);
                                }
                            }
                            
                            const container = document.getElementById('customSectionsContainer');
                            const section = document.createElement('div');
                            section.className = 'custom-section-container';
                            section.id = sectionId;
                            section.innerHTML = `
                                <div class="form-group">
                                    <label>Section Title</label>
                                    <input type="text" class="custom-section-title-input" id="${sectionId}-title" placeholder="e.g., Awards, Publications, Hobbies" oninput="updateCV()" value="${sectionData.title || ''}">
                                </div>
                                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                                    <button class="move-btn" onclick="moveSectionUp('${sectionId}')">â†‘ Move Up</button>
                                    <button class="move-btn" onclick="moveSectionDown('${sectionId}')">â†“ Move Down</button>
                                </div>
                                <div id="${sectionId}-entries"></div>
                                <button class="add-btn" onclick="addCustomSectionEntry('${sectionId}')">+ Add Entry</button>
                                <button class="remove-btn" onclick="removeCustomSection('${sectionId}')" style="width: 100%; margin-top: 10px;">Remove Section</button>
                            `;
                            container.appendChild(section);
                            
                            // Add entries
                            if (sectionData.entries) {
                                sectionData.entries.forEach(entry => {
                                    customSections[sectionId].entryCount++;
                                    const entryCount = customSections[sectionId].entryCount;
                                    const entryContainer = document.getElementById(`${sectionId}-entries`);
                                    const entryElement = document.createElement('div');
                                    entryElement.className = 'entry';
                                    entryElement.id = `${sectionId}-entry-${entryCount}`;
                                    entryElement.innerHTML = `
                                        <div class="form-group">
                                            <label>Title/Name</label>
                                            <input type="text" id="${sectionId}-entry-${entryCount}-name" oninput="updateCV()" value="${entry.name || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label>Subtitle (Optional)</label>
                                            <input type="text" id="${sectionId}-entry-${entryCount}-subtitle" oninput="updateCV()" value="${entry.subtitle || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label>Date (Optional)</label>
                                            <input type="text" id="${sectionId}-entry-${entryCount}-date" oninput="updateCV()" value="${entry.date || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label>Description (Optional)</label>
                                            <textarea id="${sectionId}-entry-${entryCount}-description" oninput="updateCV()">${entry.description || ''}</textarea>
                                        </div>
                                        <button class="remove-btn" onclick="removeEntry('${sectionId}-entry-${entryCount}', updateCV)">Remove Entry</button>
                                    `;
                                    entryContainer.appendChild(entryElement);
                                });
                            }
                        });
                    }
                    
                    // Restore declaration
                    if (data.declaration) {
                        document.getElementById('declaration').value = data.declaration.text || '';
                        document.getElementById('showSignature').checked = data.declaration.showSignature !== false;
                    }
                    
                    // Reset file input
                    event.target.value = '';
                    
                    // Update the CV
                    updateCV();
                    
                    alert('CV data imported successfully!');
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data. Please make sure you selected a valid CV data file.');
                }
            };
            reader.readAsText(file);
        }

        // Initialize
        updateCV();
    </script>

    </div>

    <script>
        // Navigation Script
        function showPage(page) {
            // Prevent any default behavior
            if (typeof event !== 'undefined') {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected page
            if (page === 'landing') {
                document.getElementById('landingPage').classList.add('active');
            } else if (page === 'letter') {
                document.getElementById('letterPage').classList.add('active');
            } else if (page === 'cv') {
                document.getElementById('cvPage').classList.add('active');
            }

            // Force scroll to top
            window.scrollTo({
                top: 0,
                left: 0,
                behavior: 'instant'
            });
            
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
            
            return false;
        }

        // Letter Writer Script
        (function() {

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        let passportPhotoData = null;
        let signatureImageData = null;

        // Check server status on load
        function checkServerStatus() {
            fetch('http://localhost:5000/health', {
                method: 'GET',
                timeout: 2000
            })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('serverStatus').textContent = 'Connected âœ”';
                        document.getElementById('serverStatus').style.color = '#4CAF50';
                    } else {
                        throw new Error('Server not responding');
                    }
                })
                .catch(error => {
                    document.getElementById('serverStatus').textContent = 'Offline (Browser mode)';
                    document.getElementById('serverStatus').style.color = '#FF9800';
                });
        }

        // Check status on load
        checkServerStatus();

        // Recheck every 30 seconds
        setInterval(checkServerStatus, 30000);

        function toggleThroughSection() {
            const showThrough = document.getElementById('showThrough').checked;
            const throughInputs = document.getElementById('throughSectionInputs');
            
            if (showThrough) {
                throughInputs.style.display = 'block';
            } else {
                throughInputs.style.display = 'none';
            }
            
            updateLetter();
        }

        function addCustomDetail() {
            const container = document.getElementById('customDetailsContainer');
            const newDetail = document.createElement('div');
            newDetail.className = 'custom-detail-item';
            newDetail.style.display = 'flex';
            newDetail.style.gap = '5px';
            newDetail.style.marginBottom = '5px';
            newDetail.innerHTML = `
                <input type="text" class="customDetail" placeholder="e.g., P.O. Box 12345" oninput="updateLetter()" style="flex: 1;">
                <button type="button" class="secondary-btn" style="padding: 8px 12px;" onclick="removeCustomDetail(this)">âœ•</button>
            `;
            container.appendChild(newDetail);
        }

        function removeCustomDetail(button) {
            const container = document.getElementById('customDetailsContainer');
            const items = container.getElementsByClassName('custom-detail-item');

            // Keep at least one custom detail field
            if (items.length > 1) {
                button.parentElement.remove();
                updateLetter();
            }
        }

        function handlePassportPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    passportPhotoData = e.target.result;
                    updateLetter();
                };
                reader.readAsDataURL(file);
            }
        }

        function removePassportPhoto() {
            passportPhotoData = null;
            document.getElementById('passportPhoto').value = '';
            updateLetter();
        }

        function handleSignatureImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    signatureImageData = e.target.result;
                    updateLetter();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeSignature() {
            signatureImageData = null;
            document.getElementById('signatureImage').value = '';
            updateLetter();
        }

        function handleSalutationChange() {
            const salutation = document.getElementById('salutation').value;
            const customInput = document.getElementById('customSalutation');

            if (salutation === 'CUSTOM') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
            updateLetter();
        }

        function handleValedictionChange() {
            const valediction = document.getElementById('valediction').value;
            const customInput = document.getElementById('customValediction');

            if (valediction === 'CUSTOM') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
            updateLetter();
        }

        function formatText(command) {
            const textarea = document.getElementById('body');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (selectedText) {
                let formattedText = selectedText;
                let tag = '';

                switch (command) {
                    case 'bold':
                        tag = 'b';
                        break;
                    case 'italic':
                        tag = 'i';
                        break;
                    case 'underline':
                        tag = 'u';
                        break;
                    case 'strikethrough':
                        tag = 's';
                        break;
                    case 'color':
                        const color = document.getElementById('textColor').value;
                        formattedText = `<span style="color: ${color}">${selectedText}</span>`;
                        break;
                }

                if (tag) {
                    formattedText = `<${tag}>${selectedText}</${tag}>`;
                }

                textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
                updateLetter();
            }
        }

        function updateLetter() {
            const fontFamily = document.getElementById('fontFamily').value;
            const letterPreview = document.getElementById('letterPreview');
            letterPreview.style.fontFamily = fontFamily;

            // Passport Photo
            const passportPhoto = document.getElementById('passportPhotoPreview');
            if (passportPhotoData) {
                passportPhoto.src = passportPhotoData;
                passportPhoto.style.display = 'block';
            } else {
                passportPhoto.style.display = 'none';
            }

            // Sender Address (Right side at top)
            const senderName = document.getElementById('senderName').value;
            const senderAddress = document.getElementById('senderAddress').value;
            const senderCity = document.getElementById('senderCity').value;
            const senderPhone = document.getElementById('senderPhone').value;
            const senderEmail = document.getElementById('senderEmail').value;
            const showSenderEmail = document.getElementById('showSenderEmail').checked;

            // Collect all custom details
            const customDetailInputs = document.getElementsByClassName('customDetail');
            const senderCustomDetails = [];
            for (let i = 0; i < customDetailInputs.length; i++) {
                if (customDetailInputs[i].value.trim()) {
                    senderCustomDetails.push(customDetailInputs[i].value.trim());
                }
            }

            const date = document.getElementById('date').value;

            let senderHTML = '';
            if (senderName) senderHTML += `<div class="address-line">${senderName},</div>`;
            if (senderAddress) senderHTML += `<div class="address-line">${senderAddress},</div>`;
            if (senderCity) senderHTML += `<div class="address-line">${senderCity},</div>`;
            if (senderPhone) senderHTML += `<div class="address-line">${senderPhone},</div>`;
            if (senderEmail && showSenderEmail) senderHTML += `<div class="address-line">${senderEmail},</div>`;

            // Add all custom details
            senderCustomDetails.forEach(detail => {
                senderHTML += `<div class="address-line">${detail},</div>`;
            });

            if (date) {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                senderHTML += `<div class="address-line" style="margin-top: 8px;">${formattedDate}.</div>`;
            }

            document.getElementById('senderAddressDisplay').innerHTML = senderHTML;

            // Receiver Address (Left side)
            const receiverTitle = document.getElementById('receiverTitle').value;
            const receiverOrg = document.getElementById('receiverOrg').value;
            const receiverAddress = document.getElementById('receiverAddress').value;
            const receiverCity = document.getElementById('receiverCity').value;

            let receiverHTML = '';
            if (receiverTitle) receiverHTML += `<div class="address-line">${receiverTitle},</div>`;
            if (receiverOrg) receiverHTML += `<div class="address-line">${receiverOrg},</div>`;
            if (receiverAddress) receiverHTML += `<div class="address-line">${receiverAddress},</div>`;
            if (receiverCity) receiverHTML += `<div class="address-line">${receiverCity}.</div>`;

            document.getElementById('receiverAddressDisplay').innerHTML = receiverHTML;

            // Through Address (if enabled)
            const showThrough = document.getElementById('showThrough').checked;
            const throughDisplay = document.getElementById('throughAddressDisplay');
            
            if (showThrough) {
                const throughType = document.getElementById('throughType').value;
                const throughTitle = document.getElementById('throughTitle').value;
                const throughOrg = document.getElementById('throughOrg').value;
                const throughAddress = document.getElementById('throughAddress').value;
                const throughCity = document.getElementById('throughCity').value;

                let throughHTML = `<div class="address-line" style="font-weight: bold; margin-bottom: 8px;">${throughType}</div>`;
                
                if (throughTitle) throughHTML += `<div class="address-line">${throughTitle},</div>`;
                if (throughOrg) throughHTML += `<div class="address-line">${throughOrg},</div>`;
                if (throughAddress) throughHTML += `<div class="address-line">${throughAddress},</div>`;
                if (throughCity) throughHTML += `<div class="address-line">${throughCity}.</div>`;

                throughDisplay.innerHTML = throughHTML;
                throughDisplay.style.display = 'block';
            } else {
                throughDisplay.style.display = 'none';
            }

            // Salutation
            const showSalutation = document.getElementById('showSalutation').checked;
            const salutationSelect = document.getElementById('salutation').value;
            let salutationText = '';

            if (showSalutation) {
                if (salutationSelect === 'CUSTOM') {
                    salutationText = document.getElementById('customSalutation').value || 'Ndugu';
                } else {
                    salutationText = salutationSelect;
                }
                document.getElementById('salutationDisplay').textContent = salutationText + ',';
                document.getElementById('salutationDisplay').style.display = 'block';
            } else {
                document.getElementById('salutationDisplay').style.display = 'none';
            }

            // Letter Header (REF/YAH)
            const showRefHeader = document.getElementById('showRefHeader').checked;
            const refType = document.getElementById('refType').value;
            let refHeader = document.getElementById('refHeader').value;

            if (showRefHeader && refHeader) {
                if (!refHeader.endsWith('.')) {
                    refHeader += '.';
                }
                document.getElementById('letterRefHeader').innerHTML = `${refType}: <span style="font-weight: bold;">${refHeader}</span>`;
                document.getElementById('letterRefHeader').style.display = 'block';
            } else {
                document.getElementById('letterRefHeader').style.display = 'none';
            }

            // Body
            const body = document.getElementById('body').value;
            const indentParagraphs = document.getElementById('indentParagraphs').checked;
            const lineSpacing = document.getElementById('lineSpacing').value;
            const paragraphs = body.split('\n').filter(p => p.trim() !== '');

            let bodyHTML = '';
            paragraphs.forEach(paragraph => {
                const className = indentParagraphs ? 'indented' : '';
                bodyHTML += `<p class="${className}" style="line-height: ${lineSpacing};">${paragraph}</p>`;
            });

            document.getElementById('letterBody').innerHTML = bodyHTML;
            document.getElementById('letterBody').style.lineHeight = lineSpacing;

            // Valediction
            const valedictionSelect = document.getElementById('valediction').value;
            let valedictionText = '';

            if (valedictionSelect === 'CUSTOM') {
                valedictionText = document.getElementById('customValediction').value || 'Wako katika Kazi';
            } else {
                valedictionText = valedictionSelect;
            }
            document.getElementById('valedictionDisplay').textContent = valedictionText + ',';

            // Signature
            const showSignatureLine = document.getElementById('showSignatureLine').checked;

            let signatureHTML = '';

            if (signatureImageData) {
                signatureHTML += `<img src="${signatureImageData}" class="signature-image">`;
            }

            if (showSignatureLine) {
                signatureHTML += `<div class="signature-line">
                    <div class="signature-name">${senderName || '(Your Name)'}</div>`;

                if (senderPhone) {
                    signatureHTML += `<div class="signature-contact">${senderPhone}</div>`;
                }

                if (senderEmail && showSenderEmail) {
                    signatureHTML += `<div class="signature-contact">${senderEmail}</div>`;
                }

                signatureHTML += `</div>`;
            } else if (senderName && !signatureImageData) {
                signatureHTML += `<div style="margin-top: 40px;">
                    <div class="signature-name">${senderName}</div>`;

                if (senderPhone) {
                    signatureHTML += `<div class="signature-contact">${senderPhone}</div>`;
                }

                if (senderEmail && showSenderEmail) {
                    signatureHTML += `<div class="signature-contact">${senderEmail}</div>`;
                }

                signatureHTML += `</div>`;
            }

            document.getElementById('signatureSection').innerHTML = signatureHTML;

            // Apply Header Customization (after all HTML is generated)
            const headerFontSize = document.getElementById('headerFontSize').value;
            const headerBold = document.getElementById('headerBold').checked;
            const headerLetterSpacing = document.getElementById('headerLetterSpacing').value;
            const headerLineHeight = document.getElementById('headerLineHeight').value;

            // Apply header styles to all header components including sender/receiver details (NOT the main body)
            const headerElements = document.querySelectorAll('.sender-address, .receiver-address, .through-address, .address-line, .salutation, .letter-ref-header, .valediction, .signature-section, .signature-name, .signature-contact, .signature-line');
            headerElements.forEach(element => {
                element.style.fontSize = headerFontSize + 'pt';
                element.style.fontWeight = headerBold ? 'bold' : 'normal';
                element.style.letterSpacing = headerLetterSpacing + 'px';
                element.style.lineHeight = headerLineHeight;
            });
        }

        function exportToWord() {
            const letterData = collectLetterData();

            // Send to server
            fetch('http://localhost:5000/export/word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(letterData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Server not available');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'letter.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Word export requires the export server.\n\nTo use Word export:\n1. Run: python letter_export_server.py\n2. Or use "Export to PDF" or "Print" instead (fully offline)');
                });
        }

        function exportToPDF() {
            const letterData = collectLetterData();

            // Try to use export server first
            fetch('http://localhost:5000/export/pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(letterData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Server not available');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'letter.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    // Fallback to browser print (fully offline)
                    console.log('Using browser print (offline mode)');
                    if (confirm('Export server not available. Use browser Print to PDF instead?\n\nClick OK, then choose "Save as PDF" in the print dialog.')) {
                        window.print();
                    }
                });
        }

        function collectLetterData() {
            // Collect all custom details
            const customDetailInputs = document.getElementsByClassName('customDetail');
            const senderCustomDetails = [];
            for (let i = 0; i < customDetailInputs.length; i++) {
                if (customDetailInputs[i].value.trim()) {
                    senderCustomDetails.push(customDetailInputs[i].value.trim());
                }
            }

            return {
                font: document.getElementById('fontFamily').value,
                headerFontSize: document.getElementById('headerFontSize').value,
                headerBold: document.getElementById('headerBold').checked,
                headerLetterSpacing: document.getElementById('headerLetterSpacing').value,
                headerLineHeight: document.getElementById('headerLineHeight').value,
                passportPhoto: passportPhotoData,
                senderName: document.getElementById('senderName').value,
                senderAddress: document.getElementById('senderAddress').value,
                senderCity: document.getElementById('senderCity').value,
                senderPhone: document.getElementById('senderPhone').value,
                senderEmail: document.getElementById('senderEmail').value,
                showSenderEmail: document.getElementById('showSenderEmail').checked,
                senderCustomDetails: senderCustomDetails,
                date: document.getElementById('date').value ? new Date(document.getElementById('date').value).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : '',
                receiverTitle: document.getElementById('receiverTitle').value,
                receiverOrg: document.getElementById('receiverOrg').value,
                receiverAddress: document.getElementById('receiverAddress').value,
                receiverCity: document.getElementById('receiverCity').value,
                showThrough: document.getElementById('showThrough').checked,
                throughType: document.getElementById('throughType').value,
                throughTitle: document.getElementById('throughTitle').value,
                throughOrg: document.getElementById('throughOrg').value,
                throughAddress: document.getElementById('throughAddress').value,
                throughCity: document.getElementById('throughCity').value,
                showSalutation: document.getElementById('showSalutation').checked,
                salutation: document.getElementById('salutation').value === 'CUSTOM'
                    ? document.getElementById('customSalutation').value
                    : document.getElementById('salutation').value,
                showRefHeader: document.getElementById('showRefHeader').checked,
                refType: document.getElementById('refType').value,
                refHeader: document.getElementById('refHeader').value,
                body: document.getElementById('body').value,
                indentParagraphs: document.getElementById('indentParagraphs').checked,
                valediction: document.getElementById('valediction').value === 'CUSTOM'
                    ? document.getElementById('customValediction').value
                    : document.getElementById('valediction').value,
                showSignatureLine: document.getElementById('showSignatureLine').checked,
                signatureImage: signatureImageData
            };
        }

        function exportToJSON() {
            const letterData = collectLetterData();

            // Add images as base64
            letterData.passportPhotoBase64 = passportPhotoData;
            letterData.signatureImageBase64 = signatureImageData;

            // Convert to JSON
            const jsonString = JSON.stringify(letterData, null, 2);

            // Create blob
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);

            // Generate filename from sender's name
            const senderName = document.getElementById('senderName').value || 'Letter';
            const filename = `${senderName.replace(/[^a-z0-9]/gi, '_')}_Letter_Barua.json`;

            // Download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            alert(`Letter saved as: ${filename}\n\nYou can reload this letter anytime using "Load from JSON"!`);
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const letterData = JSON.parse(e.target.result);

                    // Restore all form fields
                    document.getElementById('fontFamily').value = letterData.font || 'Bookman Old Style';
                    document.getElementById('headerFontSize').value = letterData.headerFontSize || 10;
                    document.getElementById('headerBold').checked = letterData.headerBold || false;
                    document.getElementById('headerLetterSpacing').value = letterData.headerLetterSpacing || 0;
                    document.getElementById('headerLineHeight').value = letterData.headerLineHeight || 1.6;
                    document.getElementById('senderName').value = letterData.senderName || '';
                    document.getElementById('senderAddress').value = letterData.senderAddress || '';
                    document.getElementById('senderCity').value = letterData.senderCity || '';
                    document.getElementById('senderPhone').value = letterData.senderPhone || '';
                    document.getElementById('senderEmail').value = letterData.senderEmail || '';
                    document.getElementById('showSenderEmail').checked = letterData.showSenderEmail !== false;

                    // Restore date
                    if (letterData.date) {
                        // Convert from formatted date back to YYYY-MM-DD
                        const dateInput = document.getElementById('date');
                        dateInput.valueAsDate = new Date();
                    }

                    // Restore custom details
                    const container = document.getElementById('customDetailsContainer');
                    container.innerHTML = ''; // Clear existing
                    if (letterData.senderCustomDetails && letterData.senderCustomDetails.length > 0) {
                        letterData.senderCustomDetails.forEach(detail => {
                            const newDetail = document.createElement('div');
                            newDetail.className = 'custom-detail-item';
                            newDetail.style.display = 'flex';
                            newDetail.style.gap = '5px';
                            newDetail.style.marginBottom = '5px';
                            newDetail.innerHTML = `
                                <input type="text" class="customDetail" value="${detail}" oninput="updateLetter()" style="flex: 1;">
                                <button type="button" class="secondary-btn" style="padding: 8px 12px;" onclick="removeCustomDetail(this)">âœ•</button>
                            `;
                            container.appendChild(newDetail);
                        });
                    } else {
                        // Add at least one empty field
                        addCustomDetail();
                    }

                    // Restore receiver details
                    document.getElementById('receiverTitle').value = letterData.receiverTitle || '';
                    document.getElementById('receiverOrg').value = letterData.receiverOrg || '';
                    document.getElementById('receiverAddress').value = letterData.receiverAddress || '';
                    document.getElementById('receiverCity').value = letterData.receiverCity || '';

                    // Restore through section
                    document.getElementById('showThrough').checked = letterData.showThrough || false;
                    document.getElementById('throughType').value = letterData.throughType || 'THROUGH';
                    document.getElementById('throughTitle').value = letterData.throughTitle || '';
                    document.getElementById('throughOrg').value = letterData.throughOrg || '';
                    document.getElementById('throughAddress').value = letterData.throughAddress || '';
                    document.getElementById('throughCity').value = letterData.throughCity || '';
                    toggleThroughSection();

                    // Restore salutation
                    document.getElementById('showSalutation').checked = letterData.showSalutation !== false;
                    const salutationValue = letterData.salutation || 'Ndugu';
                    const salutationSelect = document.getElementById('salutation');
                    // Check if it's a preset value
                    let foundSalutation = false;
                    for (let option of salutationSelect.options) {
                        if (option.value === salutationValue) {
                            salutationSelect.value = salutationValue;
                            foundSalutation = true;
                            break;
                        }
                    }
                    if (!foundSalutation) {
                        salutationSelect.value = 'CUSTOM';
                        document.getElementById('customSalutation').value = salutationValue;
                        document.getElementById('customSalutation').style.display = 'block';
                    }

                    // Restore letter header
                    document.getElementById('showRefHeader').checked = letterData.showRefHeader !== false;
                    document.getElementById('refType').value = letterData.refType || 'YAH';
                    document.getElementById('refHeader').value = letterData.refHeader || '';

                    // Restore body
                    document.getElementById('body').value = letterData.body || '';
                    document.getElementById('indentParagraphs').checked = letterData.indentParagraphs !== false;

                    // Restore valediction
                    const valedictionValue = letterData.valediction || 'Wako katika Kazi';
                    const valedictionSelect = document.getElementById('valediction');
                    let foundValediction = false;
                    for (let option of valedictionSelect.options) {
                        if (option.value === valedictionValue) {
                            valedictionSelect.value = valedictionValue;
                            foundValediction = true;
                            break;
                        }
                    }
                    if (!foundValediction) {
                        valedictionSelect.value = 'CUSTOM';
                        document.getElementById('customValediction').value = valedictionValue;
                        document.getElementById('customValediction').style.display = 'block';
                    }

                    // Restore signature
                    document.getElementById('showSignatureLine').checked = letterData.showSignatureLine !== false;

                    // Restore images
                    if (letterData.passportPhotoBase64) {
                        passportPhotoData = letterData.passportPhotoBase64;
                    }
                    if (letterData.signatureImageBase64) {
                        signatureImageData = letterData.signatureImageBase64;
                    }

                    // Update preview
                    updateLetter();

                    alert('Letter loaded successfully!\n\nAll data has been restored from the JSON file.');

                } catch (error) {
                    alert('Error loading JSON file:\n' + error.message);
                    console.error('JSON import error:', error);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Initialize letter
        updateLetter();
    
        })();

        // CV Builder Script
        (function() {

        let experienceCount = 0;
        let educationCount = 0;
        let certificationCount = 0;
        let volunteerCount = 0;
        let referenceCount = 0;
        let customDetailCount = 0;
        let customSectionCount = 0;
        let custom2Count = 0;
        let photoData = null;

        // Store custom sections data
        const customSections = {};

        // Default section order
        let sectionOrder = ['education', 'skills', 'experience', 'certification', 'volunteer', 'referees', 'custom2', 'declaration'];

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                    const photoPreview = document.getElementById('photoPreview');
                    const photoContainer = document.getElementById('photoContainer');
                    const photoPlaceholder = document.getElementById('photoPlaceholder');
                    
                    photoPreview.src = photoData;
                    photoPreview.style.display = 'block';
                    photoPlaceholder.style.display = 'none';
                    photoContainer.classList.remove('hidden');
                    updateCV();
                };
                reader.readAsDataURL(file);
            }
        }

        function moveSectionUp(sectionId) {
            const index = sectionOrder.indexOf(sectionId);
            if (index > 0) {
                [sectionOrder[index], sectionOrder[index - 1]] = [sectionOrder[index - 1], sectionOrder[index]];
                updateCV();
            }
        }

        function moveSectionDown(sectionId) {
            const index = sectionOrder.indexOf(sectionId);
            if (index < sectionOrder.length - 1 && index !== -1) {
                [sectionOrder[index], sectionOrder[index + 1]] = [sectionOrder[index + 1], sectionOrder[index]];
                updateCV();
            }
        }

        function addCustomDetail() {
            customDetailCount++;
            const container = document.getElementById('customDetailsContainer');
            const entry = document.createElement('div');
            entry.className = 'custom-detail-entry';
            entry.id = `customDetail-${customDetailCount}`;
            entry.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Header</label>
                    <input type="text" id="customHeader-${customDetailCount}" placeholder="e.g., License" oninput="updateCV()">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Detail</label>
                    <input type="text" id="customValue-${customDetailCount}" placeholder="e.g., Class A" oninput="updateCV()">
                </div>
                <button class="mini-remove-btn" onclick="removeEntry('customDetail-${customDetailCount}', updateCV)">âœ•</button>
            `;
            container.appendChild(entry);
        }

        function addExperience() {
            experienceCount++;
            const container = document.getElementById('experienceContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `experience-${experienceCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Experience #${experienceCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="expVisible-${experienceCount}" checked onchange="updateCV()">
                        <label for="expVisible-${experienceCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Job Title</label>
                    <input type="text" id="expTitle-${experienceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="expCompany-${experienceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="expLocation-${experienceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <input type="text" id="expDate-${experienceCount}" placeholder="Jan 2020 - Present" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Duties/Responsibilities</label>
                    <textarea id="expDesc-${experienceCount}" placeholder="- Achievement 1
- Achievement 2
- Achievement 3" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('experience-${experienceCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addEducation() {
            educationCount++;
            const container = document.getElementById('educationContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `education-${educationCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Education #${educationCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="eduVisible-${educationCount}" checked onchange="updateCV()">
                        <label for="eduVisible-${educationCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Qualification</label>
                    <input type="text" id="eduDegree-${educationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Institution</label>
                    <input type="text" id="eduInstitution-${educationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="eduLocation-${educationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="text" id="eduYear-${educationCount}" placeholder="2015 - 2019" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="eduDesc-${educationCount}" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('education-${educationCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addCertification() {
            certificationCount++;
            const container = document.getElementById('certificationContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `certification-${certificationCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Certification #${certificationCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="certVisible-${certificationCount}" checked onchange="updateCV()">
                        <label for="certVisible-${certificationCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Certification Name</label>
                    <input type="text" id="certName-${certificationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Organization</label>
                    <input type="text" id="certOrg-${certificationCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" id="certDate-${certificationCount}" placeholder="Jan 2020" oninput="updateCV()">
                </div>
                <button class="remove-btn" onclick="removeEntry('certification-${certificationCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addVolunteer() {
            volunteerCount++;
            const container = document.getElementById('volunteerContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `volunteer-${volunteerCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Volunteer Work #${volunteerCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="volVisible-${volunteerCount}" checked onchange="updateCV()">
                        <label for="volVisible-${volunteerCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" id="volRole-${volunteerCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Organization</label>
                    <input type="text" id="volOrg-${volunteerCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" id="volDate-${volunteerCount}" placeholder="2020" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="volDesc-${volunteerCount}" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('volunteer-${volunteerCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addReference() {
            referenceCount++;
            const container = document.getElementById('referenceContainer');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `reference-${referenceCount}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Reference #${referenceCount}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="refVisible-${referenceCount}" checked onchange="updateCV()">
                        <label for="refVisible-${referenceCount}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="refName-${referenceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Title/Position</label>
                    <input type="text" id="refTitle-${referenceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="refPhone-${referenceCount}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="refEmail-${referenceCount}" oninput="updateCV()">
                </div>
                <button class="remove-btn" onclick="removeEntry('reference-${referenceCount}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function addCustom2Entry() {
            custom2Count++;
            const titleHeader = document.getElementById('custom2TitleHeader').value || 'Title';
            const descHeader = document.getElementById('custom2DescHeader').value || 'Description';
            
            const container = document.getElementById('custom2Container');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `custom2-${custom2Count}`;
            entry.innerHTML = `
                <div class="entry-header">
                    <div class="entry-title">Entry #${custom2Count}</div>
                    <div class="visibility-control">
                        <input type="checkbox" id="custom2Visible-${custom2Count}" checked onchange="updateCV()">
                        <label for="custom2Visible-${custom2Count}">Show in CV</label>
                    </div>
                </div>
                <div class="form-group">
                    <label id="custom2TitleLabel-${custom2Count}">${titleHeader}</label>
                    <input type="text" id="custom2Title-${custom2Count}" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label id="custom2DescLabel-${custom2Count}">${descHeader}</label>
                    <textarea id="custom2Desc-${custom2Count}" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeEntry('custom2-${custom2Count}', updateCV)">Remove</button>
            `;
            container.appendChild(entry);
        }

        function updateCustom2Labels() {
            const titleHeader = document.getElementById('custom2TitleHeader').value || 'Title';
            const descHeader = document.getElementById('custom2DescHeader').value || 'Description';
            
            for (let i = 1; i <= custom2Count + 100; i++) {
                const titleLabel = document.getElementById(`custom2TitleLabel-${i}`);
                const descLabel = document.getElementById(`custom2DescLabel-${i}`);
                
                if (titleLabel) titleLabel.textContent = titleHeader;
                if (descLabel) descLabel.textContent = descHeader;
            }
        }

        function addCustomSection() {
            customSectionCount++;
            const sectionId = `customSection-${customSectionCount}`;
            customSections[sectionId] = { entries: [], entryCount: 0 };
            
            // Add to section order (before referees)
            const refIndex = sectionOrder.indexOf('referees');
            if (refIndex !== -1) {
                sectionOrder.splice(refIndex, 0, sectionId);
            } else {
                // If no referees, try before declaration
                const declIndex = sectionOrder.indexOf('declaration');
                if (declIndex !== -1) {
                    sectionOrder.splice(declIndex, 0, sectionId);
                } else {
                    sectionOrder.push(sectionId);
                }
            }
            
            const container = document.getElementById('customSectionsContainer');
            const section = document.createElement('div');
            section.className = 'custom-section-container';
            section.id = sectionId;
            section.innerHTML = `
                <div class="form-group">
                    <label>Section Title</label>
                    <input type="text" class="custom-section-title-input" id="${sectionId}-title" placeholder="e.g., Awards, Publications, Hobbies" oninput="updateCV()">
                </div>
                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <button class="move-btn" onclick="moveSectionUp('${sectionId}')">â†‘ Move Up</button>
                    <button class="move-btn" onclick="moveSectionDown('${sectionId}')">â†“ Move Down</button>
                </div>
                <div id="${sectionId}-entries"></div>
                <button class="add-btn" onclick="addCustomSectionEntry('${sectionId}')">+ Add Entry</button>
                <button class="remove-btn" onclick="removeCustomSection('${sectionId}')">Remove Section</button>
            `;
            container.appendChild(section);
        }

        function addCustomSectionEntry(sectionId) {
            const section = customSections[sectionId];
            section.entryCount++;
            const entryId = `${sectionId}-entry-${section.entryCount}`;
            
            const container = document.getElementById(`${sectionId}-entries`);
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = entryId;
            entry.innerHTML = `
                <div class="form-group">
                    <label>Title/Name</label>
                    <input type="text" id="${entryId}-name" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Subtitle (Optional)</label>
                    <input type="text" id="${entryId}-subtitle" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Date (Optional)</label>
                    <input type="text" id="${entryId}-date" placeholder="2020" oninput="updateCV()">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="${entryId}-description" oninput="updateCV()"></textarea>
                </div>
                <button class="remove-btn" onclick="removeCustomSectionEntry('${sectionId}', '${entryId}')">Remove Entry</button>
            `;
            container.appendChild(entry);
        }

        function removeCustomSectionEntry(sectionId, entryId) {
            document.getElementById(entryId).remove();
            updateCV();
        }

        function removeCustomSection(sectionId) {
            document.getElementById(sectionId).remove();
            delete customSections[sectionId];
            const index = sectionOrder.indexOf(sectionId);
            if (index !== -1) {
                sectionOrder.splice(index, 1);
            }
            updateCV();
        }

        function removeEntry(id, callback) {
            document.getElementById(id).remove();
            if (callback) callback();
        }

        function formatBullets(text) {
            if (!text) return '';
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return '';
            
            const hasBullets = lines.some(line => line.trim().startsWith('-') || line.trim().startsWith('â€¢'));
            
            if (hasBullets) {
                const formatted = lines.map(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('-') || trimmed.startsWith('â€¢')) {
                        return '<li>' + trimmed.substring(1).trim() + '</li>';
                    }
                    return '<li>' + trimmed + '</li>';
                }).join('');
                return '<ul>' + formatted + '</ul>';
            }
            
            return '<p>' + lines.join('<br>') + '</p>';
        }

        function capitalizeText(text) {
            if (!text) return '';
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        function createTableWithHeaders(items, columns, visibleColumns = null) {
            if (items.length === 0) return '';
            
            // Filter columns if visibleColumns is provided
            const displayColumns = visibleColumns ? columns.filter(col => visibleColumns.includes(col)) : columns;
            
            if (displayColumns.length === 0) return '';
            
            // Create header row
            let headerRow = '<tr>';
            displayColumns.forEach(col => {
                headerRow += `<th>${col}</th>`;
            });
            headerRow += '</tr>';
            
            // Create data rows
            let dataRows = '';
            items.forEach(item => {
                dataRows += '<tr>';
                displayColumns.forEach(col => {
                    const value = item[col] || '';
                    dataRows += `<td>${value}</td>`;
                });
                dataRows += '</tr>';
            });
            
            return `<thead>${headerRow}</thead><tbody>${dataRows}</tbody>`;
        }

        function applyTextCase(text) {
            if (!text) return '';
            const textCase = document.getElementById('textCase').value;
            
            switch(textCase) {
                case 'uppercase':
                    return text.toUpperCase();
                case 'lowercase':
                    return text.toLowerCase();
                case 'capitalize':
                    // Sentence case
                    return text;
                case 'none':
                    return text;
                default:
                    return text;
            }
        }

        function updateCV() {
            // Apply text case class to CV document
            const cvDocument = document.getElementById('cvDocument');
            const textCase = document.getElementById('textCase').value;
            cvDocument.className = 'cv-document text-' + textCase;
            
            // Update name and watermark
            const name = document.getElementById('fullName').value || 'Your Name';
            document.getElementById('displayName').textContent = name;
            document.getElementById('watermark').textContent = name;

            // Update photo visibility
            const headerSection = document.getElementById('headerSection');
            const photoContainer = document.getElementById('photoContainer');
            if (!photoData) {
                photoContainer.classList.add('hidden');
                headerSection.classList.add('no-photo');
            } else {
                photoContainer.classList.remove('hidden');
                headerSection.classList.remove('no-photo');
            }

            // Update personal details table in specific order
            const personalDetailsTable = document.getElementById('personalDetailsTable');
            personalDetailsTable.innerHTML = '';

            const dob = document.getElementById('dob').value;
            const gender = document.getElementById('gender').value;
            const nationality = document.getElementById('nationality').value;
            const language = document.getElementById('language').value;
            const maritalStatus = document.getElementById('maritalStatus').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;

            if (dob) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Date Of Birth:</td><td>${dob}</td>`;
            }
            if (gender) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Sex/Gender:</td><td>${gender}</td>`;
            }
            if (nationality) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Nationality:</td><td>${nationality}</td>`;
            }
            if (language) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Language:</td><td>${language}</td>`;
            }
            if (maritalStatus) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Marital Status:</td><td>${maritalStatus}</td>`;
            }
            if (phone) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Phone Number:</td><td>${phone}</td>`;
            }
            if (email) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>E-mail:</td><td>${email}</td>`;
            }
            if (address) {
                const row = personalDetailsTable.insertRow();
                row.innerHTML = `<td>Address:</td><td>${address}</td>`;
            }

            // Add custom details
            for (let i = 1; i <= customDetailCount + 100; i++) {
                const headerEl = document.getElementById(`customHeader-${i}`);
                const valueEl = document.getElementById(`customValue-${i}`);
                if (headerEl && valueEl && headerEl.value && valueEl.value) {
                    const row = personalDetailsTable.insertRow();
                    row.innerHTML = `<td>${headerEl.value}:</td><td>${valueEl.value}</td>`;
                }
            }

            // Update summary
            const summary = document.getElementById('summary').value;
            if (summary) {
                document.getElementById('summarySection').style.display = 'block';
                document.getElementById('displaySummary').textContent = summary;
            } else {
                document.getElementById('summarySection').style.display = 'none';
            }

            // Build sections based on order
            const sectionsContainer = document.getElementById('sectionsContainer');
            sectionsContainer.innerHTML = '';
            
            let sectionNumber = 1;

            sectionOrder.forEach(sectionId => {
                if (sectionId === 'education') {
                    const eduContainer = document.createElement('div');
                    const education = [];
                    
                    // Get visible columns
                    const visibleCols = [];
                    if (document.getElementById('eduCol-qualification').checked) visibleCols.push('Qualification');
                    if (document.getElementById('eduCol-institution').checked) visibleCols.push('Institution');
                    if (document.getElementById('eduCol-location').checked) visibleCols.push('Location');
                    if (document.getElementById('eduCol-period').checked) visibleCols.push('Period');
                    if (document.getElementById('eduCol-details').checked) visibleCols.push('Details');
                    
                    for (let i = 1; i <= educationCount + 100; i++) {
                        const degreeEl = document.getElementById(`eduDegree-${i}`);
                        const visibleCheckbox = document.getElementById(`eduVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (degreeEl && degreeEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const institution = document.getElementById(`eduInstitution-${i}`).value;
                            const location = document.getElementById(`eduLocation-${i}`).value;
                            const year = document.getElementById(`eduYear-${i}`).value;
                            const desc = document.getElementById(`eduDesc-${i}`).value;
                            
                            const item = {
                                'Qualification': degreeEl.value,
                                'Institution': institution,
                                'Location': location,
                                'Period': year,
                                'Details': desc
                            };
                            
                            education.push(item);
                        }
                    }
                    if (education.length > 0 && visibleCols.length > 0) {
                        eduContainer.className = 'cv-section';
                        eduContainer.innerHTML = `
                            <div class="cv-section-header-box">${sectionNumber}. Education Background</div>
                            <table class="cv-unified-table">
                                ${createTableWithHeaders(education, ['Qualification', 'Institution', 'Location', 'Period', 'Details'], visibleCols)}
                            </table>
                        `;
                        sectionsContainer.appendChild(eduContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'skills') {
                    const skills = document.getElementById('skills').value;
                    if (skills) {
                        const skillsArray = skills.split(',').map(s => s.trim()).filter(s => s);
                        if (skillsArray.length > 0) {
                            const skillsContainer = document.createElement('div');
                            skillsContainer.className = 'cv-section';
                            
                            let skillsHtml = '<div class="cv-skills-grid">';
                            skillsArray.forEach(skill => {
                                skillsHtml += `<div class="cv-skill-item">${skill}</div>`;
                            });
                            skillsHtml += '</div>';
                            
                            skillsContainer.innerHTML = `
                                <div class="cv-section-header-box">${sectionNumber}. Skills</div>
                                <table class="cv-skills-table">
                                    <tbody>
                                        <tr>
                                            <td>${skillsHtml}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                            sectionsContainer.appendChild(skillsContainer);
                            sectionNumber++;
                        }
                    }
                } else if (sectionId === 'experience') {
                    const expContainer = document.createElement('div');
                    const experiences = [];
                    
                    // Get visible columns (excluding Details as it will be shown separately)
                    const visibleCols = [];
                    if (document.getElementById('expCol-position').checked) visibleCols.push('Position');
                    if (document.getElementById('expCol-company').checked) visibleCols.push('Company');
                    if (document.getElementById('expCol-location').checked) visibleCols.push('Location');
                    if (document.getElementById('expCol-period').checked) visibleCols.push('Period');
                    
                    for (let i = 1; i <= experienceCount + 100; i++) {
                        const titleEl = document.getElementById(`expTitle-${i}`);
                        const visibleCheckbox = document.getElementById(`expVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (titleEl && titleEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const company = document.getElementById(`expCompany-${i}`).value;
                            const location = document.getElementById(`expLocation-${i}`).value;
                            const date = document.getElementById(`expDate-${i}`).value;
                            const desc = document.getElementById(`expDesc-${i}`).value;
                            
                            const item = {
                                'Position': titleEl.value,
                                'Company': company,
                                'Location': location,
                                'Period': date,
                                'Duties': desc ? formatBullets(desc) : ''
                            };
                            
                            experiences.push(item);
                        }
                    }
                    if (experiences.length > 0 && visibleCols.length > 0) {
                        expContainer.className = 'cv-section';
                        let expHtml = `
                            <div class="cv-section-header-box">${sectionNumber}. Working Experience</div>
                        `;
                        
                        // Create each experience entry with table and duties below
                        experiences.forEach((exp, index) => {
                            // Create table for this experience
                            const tableData = [exp];
                            expHtml += `
                                <table class="cv-unified-table" style="margin-bottom: 5px;">
                                    ${createTableWithHeaders(tableData, ['Position', 'Company', 'Location', 'Period'], visibleCols)}
                                </table>
                            `;
                            
                            // Add Duties/Responsibilities section below if Details column is visible and duties exist
                            if (document.getElementById('expCol-details').checked && exp.Duties) {
                                expHtml += `
                                    <div class="cv-duties-section">
                                        <div class="cv-duties-label">Duties/Responsibilities:</div>
                                        <div class="cv-duties-content">${exp.Duties}</div>
                                    </div>
                                `;
                            }
                            
                            // Add spacing between entries except for the last one
                            if (index < experiences.length - 1) {
                                expHtml += `<div style="margin-bottom: 20px;"></div>`;
                            }
                        });
                        
                        expContainer.innerHTML = expHtml;
                        sectionsContainer.appendChild(expContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'certification') {
                    const certContainer = document.createElement('div');
                    const certifications = [];
                    
                    // Get visible columns
                    const visibleCols = [];
                    if (document.getElementById('certCol-certification').checked) visibleCols.push('Certification');
                    if (document.getElementById('certCol-organization').checked) visibleCols.push('Organization');
                    if (document.getElementById('certCol-date').checked) visibleCols.push('Date');
                    
                    for (let i = 1; i <= certificationCount + 100; i++) {
                        const nameEl = document.getElementById(`certName-${i}`);
                        const visibleCheckbox = document.getElementById(`certVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (nameEl && nameEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const org = document.getElementById(`certOrg-${i}`).value;
                            const date = document.getElementById(`certDate-${i}`).value;
                            
                            const item = {
                                'Certification': nameEl.value,
                                'Organization': org,
                                'Date': date
                            };
                            
                            certifications.push(item);
                        }
                    }
                    if (certifications.length > 0 && visibleCols.length > 0) {
                        certContainer.className = 'cv-section';
                        certContainer.innerHTML = `
                            <div class="cv-section-header-box">${sectionNumber}. Certification</div>
                            <table class="cv-unified-table">
                                ${createTableWithHeaders(certifications, ['Certification', 'Organization', 'Date'], visibleCols)}
                            </table>
                        `;
                        sectionsContainer.appendChild(certContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'volunteer') {
                    const volContainer = document.createElement('div');
                    const volunteer = [];
                    
                    // Get visible columns
                    const visibleCols = [];
                    if (document.getElementById('volCol-role').checked) visibleCols.push('Role');
                    if (document.getElementById('volCol-organization').checked) visibleCols.push('Organization');
                    if (document.getElementById('volCol-date').checked) visibleCols.push('Date');
                    if (document.getElementById('volCol-description').checked) visibleCols.push('Description');
                    
                    for (let i = 1; i <= volunteerCount + 100; i++) {
                        const roleEl = document.getElementById(`volRole-${i}`);
                        const visibleCheckbox = document.getElementById(`volVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (roleEl && roleEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const org = document.getElementById(`volOrg-${i}`).value;
                            const date = document.getElementById(`volDate-${i}`).value;
                            const desc = document.getElementById(`volDesc-${i}`).value;
                            
                            const item = {
                                'Role': roleEl.value,
                                'Organization': org,
                                'Date': date,
                                'Description': desc
                            };
                            
                            volunteer.push(item);
                        }
                    }
                    if (volunteer.length > 0 && visibleCols.length > 0) {
                        volContainer.className = 'cv-section';
                        volContainer.innerHTML = `
                            <div class="cv-section-header-box">${sectionNumber}. Volunteer Work</div>
                            <table class="cv-unified-table">
                                ${createTableWithHeaders(volunteer, ['Role', 'Organization', 'Date', 'Description'], visibleCols)}
                            </table>
                        `;
                        sectionsContainer.appendChild(volContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'referees') {
                    const refContainer = document.createElement('div');
                    const references = [];
                    
                    for (let i = 1; i <= referenceCount + 100; i++) {
                        const nameEl = document.getElementById(`refName-${i}`);
                        const visibleCheckbox = document.getElementById(`refVisible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (nameEl && nameEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const title = document.getElementById(`refTitle-${i}`).value;
                            const phone = document.getElementById(`refPhone-${i}`).value;
                            const email = document.getElementById(`refEmail-${i}`).value;
                            
                            const item = {
                                'Name': nameEl.value,
                                'Title': title,
                                'Phone': phone,
                                'Email': email
                            };
                            
                            references.push(item);
                        }
                    }
                    if (references.length > 0) {
                        refContainer.className = 'cv-section';
                        let refHtml = `<div class="cv-section-header-box">${sectionNumber}. Referees</div>`;
                        
                        references.forEach(ref => {
                            refHtml += `
                                <div class="cv-referee-item">
                                    <div class="cv-referee-name">${ref.Name}</div>
                                    ${ref.Title ? `<div class="cv-referee-detail"><strong>Title:</strong> ${ref.Title}</div>` : ''}
                                    ${ref.Phone ? `<div class="cv-referee-detail"><strong>Phone:</strong> ${ref.Phone}</div>` : ''}
                                    ${ref.Email ? `<div class="cv-referee-detail"><strong>Email:</strong> ${ref.Email}</div>` : ''}
                                </div>
                            `;
                        });
                        
                        refContainer.innerHTML = refHtml;
                        sectionsContainer.appendChild(refContainer);
                        sectionNumber++;
                    }
                } else if (sectionId === 'custom2') {
                    const custom2Container = document.createElement('div');
                    const custom2Entries = [];
                    
                    const sectionTitle = document.getElementById('custom2SectionTitle').value;
                    const titleHeader = document.getElementById('custom2TitleHeader').value || 'Title';
                    const descHeader = document.getElementById('custom2DescHeader').value || 'Description';
                    
                    for (let i = 1; i <= custom2Count + 100; i++) {
                        const titleEl = document.getElementById(`custom2Title-${i}`);
                        const visibleCheckbox = document.getElementById(`custom2Visible-${i}`);
                        
                        // Only add if entry has content and visibility checkbox is checked
                        if (titleEl && titleEl.value && (!visibleCheckbox || visibleCheckbox.checked)) {
                            const desc = document.getElementById(`custom2Desc-${i}`).value;
                            
                            const item = {
                                'Title': titleEl.value,
                                'Description': desc
                            };
                            
                            custom2Entries.push(item);
                        }
                    }
                    
                    if (custom2Entries.length > 0 && sectionTitle) {
                        custom2Container.className = 'cv-section';
                        let custom2Html = `<div class="cv-section-header-box">${sectionNumber}. ${sectionTitle}</div>`;
                        
                        custom2Entries.forEach(entry => {
                            custom2Html += `
                                <div class="cv-custom2-item">
                                    <div class="cv-custom2-title">${titleHeader}: ${entry.Title}</div>
                                    ${entry.Description ? `<div class="cv-custom2-description">${descHeader}: ${entry.Description}</div>` : ''}
                                </div>
                            `;
                        });
                        
                        custom2Container.innerHTML = custom2Html;
                        sectionsContainer.appendChild(custom2Container);
                        sectionNumber++;
                    }
                } else if (sectionId === 'declaration') {
                    const declaration = document.getElementById('declaration').value;
                    const showSignature = document.getElementById('showSignature').checked;
                    
                    if (declaration) {
                        const declarationContainer = document.createElement('div');
                        declarationContainer.className = 'cv-section';
                        
                        let declarationHtml = `
                            <div class="cv-section-header-box">${sectionNumber}. Declaration</div>
                            <table class="cv-unified-table">
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="cv-declaration-text">${declaration}</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                        
                        if (showSignature) {
                            declarationHtml += `
                                <div class="cv-signature-container">
                                    <div class="cv-signature-label">Signature</div>
                                    <div class="cv-signature-line"></div>
                                </div>
                            `;
                        }
                        
                        declarationContainer.innerHTML = declarationHtml;
                        sectionsContainer.appendChild(declarationContainer);
                        sectionNumber++;
                    }
                } else if (customSections[sectionId]) {
                    const titleEl = document.getElementById(`${sectionId}-title`);
                    if (titleEl && titleEl.value) {
                        const entries = [];
                        const section = customSections[sectionId];
                        
                        for (let i = 1; i <= section.entryCount + 100; i++) {
                            const entryId = `${sectionId}-entry-${i}`;
                            const nameEl = document.getElementById(`${entryId}-name`);
                            
                            if (nameEl && nameEl.value) {
                                const subtitle = document.getElementById(`${entryId}-subtitle`).value;
                                const date = document.getElementById(`${entryId}-date`).value;
                                const description = document.getElementById(`${entryId}-description`).value;
                                
                                const item = {
                                    'Title': nameEl.value,
                                    'Subtitle': subtitle,
                                    'Date': date,
                                    'Description': description
                                };
                                
                                entries.push(item);
                            }
                        }
                        
                        if (entries.length > 0) {
                            const customContainer = document.createElement('div');
                            customContainer.className = 'cv-section';
                            customContainer.innerHTML = `
                                <div class="cv-section-header-box">${sectionNumber}. ${titleEl.value}</div>
                                <table class="cv-unified-table">
                                    ${createTableWithHeaders(entries, ['Title', 'Subtitle', 'Date', 'Description'])}
                                </table>
                            `;
                            sectionsContainer.appendChild(customContainer);
                            sectionNumber++;
                        }
                    }
                }
            });
        }

        function downloadCV() {
            window.print();
        }

        function exportData() {
            const data = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                
                // Counters
                counters: {
                    experienceCount,
                    educationCount,
                    certificationCount,
                    volunteerCount,
                    referenceCount,
                    customDetailCount,
                    customSectionCount,
                    custom2Count
                },
                
                // Section order
                sectionOrder: [...sectionOrder],
                
                // Photo data
                photoData: photoData,
                
                // Basic personal info
                personalInfo: {
                    fullName: document.getElementById('fullName').value,
                    jobTitle: document.getElementById('jobTitle').value,
                    dob: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    language: document.getElementById('language').value,
                    maritalStatus: document.getElementById('maritalStatus').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    textCase: document.getElementById('textCase').value
                },
                
                // Custom details
                customDetails: [],
                
                // Professional summary
                summary: document.getElementById('summary').value,
                
                // Skills
                skills: document.getElementById('skills').value,
                
                // Column visibility
                columnVisibility: {
                    education: {
                        qualification: document.getElementById('eduCol-qualification').checked,
                        institution: document.getElementById('eduCol-institution').checked,
                        location: document.getElementById('eduCol-location').checked,
                        period: document.getElementById('eduCol-period').checked,
                        details: document.getElementById('eduCol-details').checked
                    },
                    experience: {
                        position: document.getElementById('expCol-position').checked,
                        company: document.getElementById('expCol-company').checked,
                        location: document.getElementById('expCol-location').checked,
                        period: document.getElementById('expCol-period').checked,
                        details: document.getElementById('expCol-details').checked
                    },
                    certification: {
                        certification: document.getElementById('certCol-certification').checked,
                        organization: document.getElementById('certCol-organization').checked,
                        date: document.getElementById('certCol-date').checked
                    },
                    volunteer: {
                        role: document.getElementById('volCol-role').checked,
                        organization: document.getElementById('volCol-organization').checked,
                        date: document.getElementById('volCol-date').checked,
                        description: document.getElementById('volCol-description').checked
                    }
                },
                
                // Education entries
                education: [],
                
                // Experience entries
                experience: [],
                
                // Certification entries
                certifications: [],
                
                // Volunteer entries
                volunteer: [],
                
                // Reference entries
                references: [],
                
                // Custom2 entries
                custom2: {
                    sectionTitle: document.getElementById('custom2SectionTitle').value,
                    titleHeader: document.getElementById('custom2TitleHeader').value,
                    descHeader: document.getElementById('custom2DescHeader').value,
                    entries: []
                },
                
                // Custom sections
                customSections: {},
                
                // Declaration
                declaration: {
                    text: document.getElementById('declaration').value,
                    showSignature: document.getElementById('showSignature').checked
                }
            };
            
            // Collect custom details
            for (let i = 1; i <= customDetailCount + 100; i++) {
                const labelEl = document.getElementById(`customLabel-${i}`);
                if (labelEl && labelEl.value) {
                    data.customDetails.push({
                        label: labelEl.value,
                        value: document.getElementById(`customValue-${i}`).value
                    });
                }
            }
            
            // Collect education entries
            for (let i = 1; i <= educationCount + 100; i++) {
                const degreeEl = document.getElementById(`eduDegree-${i}`);
                const visibleEl = document.getElementById(`eduVisible-${i}`);
                if (degreeEl) {
                    data.education.push({
                        degree: degreeEl.value,
                        institution: document.getElementById(`eduInstitution-${i}`)?.value || '',
                        location: document.getElementById(`eduLocation-${i}`)?.value || '',
                        year: document.getElementById(`eduYear-${i}`)?.value || '',
                        description: document.getElementById(`eduDesc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect experience entries
            for (let i = 1; i <= experienceCount + 100; i++) {
                const titleEl = document.getElementById(`expTitle-${i}`);
                const visibleEl = document.getElementById(`expVisible-${i}`);
                if (titleEl) {
                    data.experience.push({
                        title: titleEl.value,
                        company: document.getElementById(`expCompany-${i}`)?.value || '',
                        location: document.getElementById(`expLocation-${i}`)?.value || '',
                        date: document.getElementById(`expDate-${i}`)?.value || '',
                        description: document.getElementById(`expDesc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect certification entries
            for (let i = 1; i <= certificationCount + 100; i++) {
                const nameEl = document.getElementById(`certName-${i}`);
                const visibleEl = document.getElementById(`certVisible-${i}`);
                if (nameEl) {
                    data.certifications.push({
                        name: nameEl.value,
                        organization: document.getElementById(`certOrg-${i}`)?.value || '',
                        date: document.getElementById(`certDate-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect volunteer entries
            for (let i = 1; i <= volunteerCount + 100; i++) {
                const roleEl = document.getElementById(`volRole-${i}`);
                const visibleEl = document.getElementById(`volVisible-${i}`);
                if (roleEl) {
                    data.volunteer.push({
                        role: roleEl.value,
                        organization: document.getElementById(`volOrg-${i}`)?.value || '',
                        date: document.getElementById(`volDate-${i}`)?.value || '',
                        description: document.getElementById(`volDesc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect reference entries
            for (let i = 1; i <= referenceCount + 100; i++) {
                const nameEl = document.getElementById(`refName-${i}`);
                const visibleEl = document.getElementById(`refVisible-${i}`);
                if (nameEl) {
                    data.references.push({
                        name: nameEl.value,
                        title: document.getElementById(`refTitle-${i}`)?.value || '',
                        phone: document.getElementById(`refPhone-${i}`)?.value || '',
                        email: document.getElementById(`refEmail-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect custom2 entries
            for (let i = 1; i <= custom2Count + 100; i++) {
                const titleEl = document.getElementById(`custom2Title-${i}`);
                const visibleEl = document.getElementById(`custom2Visible-${i}`);
                if (titleEl) {
                    data.custom2.entries.push({
                        title: titleEl.value,
                        description: document.getElementById(`custom2Desc-${i}`)?.value || '',
                        visible: visibleEl ? visibleEl.checked : true
                    });
                }
            }
            
            // Collect custom sections
            for (const sectionId in customSections) {
                const titleEl = document.getElementById(`${sectionId}-title`);
                if (titleEl) {
                    data.customSections[sectionId] = {
                        title: titleEl.value,
                        entryCount: customSections[sectionId].entryCount,
                        entries: []
                    };
                    
                    for (let i = 1; i <= customSections[sectionId].entryCount + 100; i++) {
                        const entryId = `${sectionId}-entry-${i}`;
                        const nameEl = document.getElementById(`${entryId}-name`);
                        if (nameEl) {
                            data.customSections[sectionId].entries.push({
                                name: nameEl.value,
                                subtitle: document.getElementById(`${entryId}-subtitle`)?.value || '',
                                date: document.getElementById(`${entryId}-date`)?.value || '',
                                description: document.getElementById(`${entryId}-description`)?.value || ''
                            });
                        }
                    }
                }
            }
            
            // Create download
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const fileName = `CV_Data_${data.personalInfo.fullName || 'Export'}_${new Date().toISOString().split('T')[0]}.json`;
            link.download = fileName.replace(/[^a-z0-9._-]/gi, '_');
            link.click();
            URL.revokeObjectURL(url);
            
            alert('CV data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Clear existing data
                    document.getElementById('educationContainer').innerHTML = '';
                    document.getElementById('experienceContainer').innerHTML = '';
                    document.getElementById('certificationContainer').innerHTML = '';
                    document.getElementById('volunteerContainer').innerHTML = '';
                    document.getElementById('referenceContainer').innerHTML = '';
                    document.getElementById('customDetailsContainer').innerHTML = '';
                    document.getElementById('custom2Container').innerHTML = '';
                    document.getElementById('customSectionsContainer').innerHTML = '';
                    
                    // Reset counters
                    experienceCount = 0;
                    educationCount = 0;
                    certificationCount = 0;
                    volunteerCount = 0;
                    referenceCount = 0;
                    customDetailCount = 0;
                    customSectionCount = 0;
                    custom2Count = 0;
                    
                    // Clear custom sections
                    for (const key in customSections) {
                        delete customSections[key];
                    }
                    
                    // Note: Section order is not restored as custom sections get new IDs
                    // Users can reorder sections after import using the up/down arrows
                    
                    // Restore photo
                    if (data.photoData) {
                        photoData = data.photoData;
                        const photoPreview = document.getElementById('photoPreview');
                        const photoPlaceholder = document.getElementById('photoPlaceholder');
                        photoPreview.src = photoData;
                        photoPreview.style.display = 'block';
                        photoPlaceholder.style.display = 'none';
                    }
                    
                    // Restore basic personal info
                    if (data.personalInfo) {
                        document.getElementById('fullName').value = data.personalInfo.fullName || '';
                        document.getElementById('jobTitle').value = data.personalInfo.jobTitle || '';
                        document.getElementById('dob').value = data.personalInfo.dob || '';
                        document.getElementById('gender').value = data.personalInfo.gender || '';
                        document.getElementById('nationality').value = data.personalInfo.nationality || '';
                        document.getElementById('language').value = data.personalInfo.language || '';
                        document.getElementById('maritalStatus').value = data.personalInfo.maritalStatus || '';
                        document.getElementById('phone').value = data.personalInfo.phone || '';
                        document.getElementById('email').value = data.personalInfo.email || '';
                        document.getElementById('address').value = data.personalInfo.address || '';
                        document.getElementById('textCase').value = data.personalInfo.textCase || 'none';
                    }
                    
                    // Restore custom details
                    if (data.customDetails) {
                        data.customDetails.forEach(detail => {
                            addCustomDetail();
                            document.getElementById(`customLabel-${customDetailCount}`).value = detail.label;
                            document.getElementById(`customValue-${customDetailCount}`).value = detail.value;
                        });
                    }
                    
                    // Restore summary
                    document.getElementById('summary').value = data.summary || '';
                    
                    // Restore skills
                    document.getElementById('skills').value = data.skills || '';
                    
                    // Restore column visibility
                    if (data.columnVisibility) {
                        if (data.columnVisibility.education) {
                            document.getElementById('eduCol-qualification').checked = data.columnVisibility.education.qualification !== false;
                            document.getElementById('eduCol-institution').checked = data.columnVisibility.education.institution !== false;
                            document.getElementById('eduCol-location').checked = data.columnVisibility.education.location !== false;
                            document.getElementById('eduCol-period').checked = data.columnVisibility.education.period !== false;
                            document.getElementById('eduCol-details').checked = data.columnVisibility.education.details !== false;
                        }
                        if (data.columnVisibility.experience) {
                            document.getElementById('expCol-position').checked = data.columnVisibility.experience.position !== false;
                            document.getElementById('expCol-company').checked = data.columnVisibility.experience.company !== false;
                            document.getElementById('expCol-location').checked = data.columnVisibility.experience.location !== false;
                            document.getElementById('expCol-period').checked = data.columnVisibility.experience.period !== false;
                            document.getElementById('expCol-details').checked = data.columnVisibility.experience.details !== false;
                        }
                        if (data.columnVisibility.certification) {
                            document.getElementById('certCol-certification').checked = data.columnVisibility.certification.certification !== false;
                            document.getElementById('certCol-organization').checked = data.columnVisibility.certification.organization !== false;
                            document.getElementById('certCol-date').checked = data.columnVisibility.certification.date !== false;
                        }
                        if (data.columnVisibility.volunteer) {
                            document.getElementById('volCol-role').checked = data.columnVisibility.volunteer.role !== false;
                            document.getElementById('volCol-organization').checked = data.columnVisibility.volunteer.organization !== false;
                            document.getElementById('volCol-date').checked = data.columnVisibility.volunteer.date !== false;
                            document.getElementById('volCol-description').checked = data.columnVisibility.volunteer.description !== false;
                        }
                    }
                    
                    // Restore education entries
                    if (data.education) {
                        data.education.forEach(edu => {
                            addEducation();
                            document.getElementById(`eduDegree-${educationCount}`).value = edu.degree || '';
                            document.getElementById(`eduInstitution-${educationCount}`).value = edu.institution || '';
                            document.getElementById(`eduLocation-${educationCount}`).value = edu.location || '';
                            document.getElementById(`eduYear-${educationCount}`).value = edu.year || '';
                            document.getElementById(`eduDesc-${educationCount}`).value = edu.description || '';
                            const visibleEl = document.getElementById(`eduVisible-${educationCount}`);
                            if (visibleEl) visibleEl.checked = edu.visible !== false;
                        });
                    }
                    
                    // Restore experience entries
                    if (data.experience) {
                        data.experience.forEach(exp => {
                            addExperience();
                            document.getElementById(`expTitle-${experienceCount}`).value = exp.title || '';
                            document.getElementById(`expCompany-${experienceCount}`).value = exp.company || '';
                            document.getElementById(`expLocation-${experienceCount}`).value = exp.location || '';
                            document.getElementById(`expDate-${experienceCount}`).value = exp.date || '';
                            document.getElementById(`expDesc-${experienceCount}`).value = exp.description || '';
                            const visibleEl = document.getElementById(`expVisible-${experienceCount}`);
                            if (visibleEl) visibleEl.checked = exp.visible !== false;
                        });
                    }
                    
                    // Restore certification entries
                    if (data.certifications) {
                        data.certifications.forEach(cert => {
                            addCertification();
                            document.getElementById(`certName-${certificationCount}`).value = cert.name || '';
                            document.getElementById(`certOrg-${certificationCount}`).value = cert.organization || '';
                            document.getElementById(`certDate-${certificationCount}`).value = cert.date || '';
                            const visibleEl = document.getElementById(`certVisible-${certificationCount}`);
                            if (visibleEl) visibleEl.checked = cert.visible !== false;
                        });
                    }
                    
                    // Restore volunteer entries
                    if (data.volunteer) {
                        data.volunteer.forEach(vol => {
                            addVolunteer();
                            document.getElementById(`volRole-${volunteerCount}`).value = vol.role || '';
                            document.getElementById(`volOrg-${volunteerCount}`).value = vol.organization || '';
                            document.getElementById(`volDate-${volunteerCount}`).value = vol.date || '';
                            document.getElementById(`volDesc-${volunteerCount}`).value = vol.description || '';
                            const visibleEl = document.getElementById(`volVisible-${volunteerCount}`);
                            if (visibleEl) visibleEl.checked = vol.visible !== false;
                        });
                    }
                    
                    // Restore reference entries
                    if (data.references) {
                        data.references.forEach(ref => {
                            addReference();
                            document.getElementById(`refName-${referenceCount}`).value = ref.name || '';
                            document.getElementById(`refTitle-${referenceCount}`).value = ref.title || '';
                            document.getElementById(`refPhone-${referenceCount}`).value = ref.phone || '';
                            document.getElementById(`refEmail-${referenceCount}`).value = ref.email || '';
                            const visibleEl = document.getElementById(`refVisible-${referenceCount}`);
                            if (visibleEl) visibleEl.checked = ref.visible !== false;
                        });
                    }
                    
                    // Restore custom2
                    if (data.custom2) {
                        document.getElementById('custom2SectionTitle').value = data.custom2.sectionTitle || '';
                        document.getElementById('custom2TitleHeader').value = data.custom2.titleHeader || 'Title';
                        document.getElementById('custom2DescHeader').value = data.custom2.descHeader || 'Description';
                        
                        if (data.custom2.entries) {
                            data.custom2.entries.forEach(entry => {
                                addCustom2Entry();
                                document.getElementById(`custom2Title-${custom2Count}`).value = entry.title || '';
                                document.getElementById(`custom2Desc-${custom2Count}`).value = entry.description || '';
                                const visibleEl = document.getElementById(`custom2Visible-${custom2Count}`);
                                if (visibleEl) visibleEl.checked = entry.visible !== false;
                            });
                        }
                        
                        updateCustom2Labels();
                    }
                    
                    // Restore custom sections
                    if (data.customSections) {
                        const keys = Object.keys(data.customSections);
                        keys.forEach((originalSectionId, idx) => {
                            const sectionData = data.customSections[originalSectionId];
                            
                            // Add a new custom section
                            customSectionCount++;
                            const sectionId = `customSection-${customSectionCount}`;
                            customSections[sectionId] = { entries: [], entryCount: 0 };
                            
                            // Add to section order (before referees)
                            const refIndex = sectionOrder.indexOf('referees');
                            if (refIndex !== -1) {
                                sectionOrder.splice(refIndex, 0, sectionId);
                            } else {
                                const declIndex = sectionOrder.indexOf('declaration');
                                if (declIndex !== -1) {
                                    sectionOrder.splice(declIndex, 0, sectionId);
                                } else {
                                    sectionOrder.push(sectionId);
                                }
                            }
                            
                            const container = document.getElementById('customSectionsContainer');
                            const section = document.createElement('div');
                            section.className = 'custom-section-container';
                            section.id = sectionId;
                            section.innerHTML = `
                                <div class="form-group">
                                    <label>Section Title</label>
                                    <input type="text" class="custom-section-title-input" id="${sectionId}-title" placeholder="e.g., Awards, Publications, Hobbies" oninput="updateCV()" value="${sectionData.title || ''}">
                                </div>
                                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                                    <button class="move-btn" onclick="moveSectionUp('${sectionId}')">â†‘ Move Up</button>
                                    <button class="move-btn" onclick="moveSectionDown('${sectionId}')">â†“ Move Down</button>
                                </div>
                                <div id="${sectionId}-entries"></div>
                                <button class="add-btn" onclick="addCustomSectionEntry('${sectionId}')">+ Add Entry</button>
                                <button class="remove-btn" onclick="removeCustomSection('${sectionId}')" style="width: 100%; margin-top: 10px;">Remove Section</button>
                            `;
                            container.appendChild(section);
                            
                            // Add entries
                            if (sectionData.entries) {
                                sectionData.entries.forEach(entry => {
                                    customSections[sectionId].entryCount++;
                                    const entryCount = customSections[sectionId].entryCount;
                                    const entryContainer = document.getElementById(`${sectionId}-entries`);
                                    const entryElement = document.createElement('div');
                                    entryElement.className = 'entry';
                                    entryElement.id = `${sectionId}-entry-${entryCount}`;
                                    entryElement.innerHTML = `
                                        <div class="form-group">
                                            <label>Title/Name</label>
                                            <input type="text" id="${sectionId}-entry-${entryCount}-name" oninput="updateCV()" value="${entry.name || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label>Subtitle (Optional)</label>
                                            <input type="text" id="${sectionId}-entry-${entryCount}-subtitle" oninput="updateCV()" value="${entry.subtitle || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label>Date (Optional)</label>
                                            <input type="text" id="${sectionId}-entry-${entryCount}-date" oninput="updateCV()" value="${entry.date || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label>Description (Optional)</label>
                                            <textarea id="${sectionId}-entry-${entryCount}-description" oninput="updateCV()">${entry.description || ''}</textarea>
                                        </div>
                                        <button class="remove-btn" onclick="removeEntry('${sectionId}-entry-${entryCount}', updateCV)">Remove Entry</button>
                                    `;
                                    entryContainer.appendChild(entryElement);
                                });
                            }
                        });
                    }
                    
                    // Restore declaration
                    if (data.declaration) {
                        document.getElementById('declaration').value = data.declaration.text || '';
                        document.getElementById('showSignature').checked = data.declaration.showSignature !== false;
                    }
                    
                    // Reset file input
                    event.target.value = '';
                    
                    // Update the CV
                    updateCV();
                    
                    alert('CV data imported successfully!');
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data. Please make sure you selected a valid CV data file.');
                }
            };
            reader.readAsText(file);
        }

        // Initialize
        updateCV();
    
        })();
    

        // ==================== BROWSER CLOSE WARNING ====================
        // Warn user before closing browser if they're on Letter or CV page
        window.addEventListener('beforeunload', function (e) {
            // Check if user is on Letter or CV page (not landing page)
            const letterPageActive = document.getElementById('letterPage').classList.contains('active');
            const cvPageActive = document.getElementById('cvPage').classList.contains('active');
            
            if (letterPageActive || cvPageActive) {
                // Standard way to trigger the browser's warning dialog
                e.preventDefault();
                // Modern browsers require returnValue to be set
                e.returnValue = '';
                // Some browsers show this message, others show their own default message
                return 'You have unsaved work. Please make sure to save or export your document before leaving.';
            }
        });

        // Optional: Add a visual indicator that auto-save is not enabled
        // This runs when the page loads
        window.addEventListener('load', function() {
            console.log('Professional Writing Center - Remember to save your work!');
        });

        // ==================== PWA SERVICE WORKER REGISTRATION ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/writing-center-pwa/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // ==================== PWA INSTALL PROMPT ====================
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = 'ðŸ“± Install App';
        installButton.style.cssText = `
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            z-index: 9998;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: none;
            transition: all 0.3s;
        `;
        installButton.onmouseover = () => {
            installButton.style.transform = 'translateY(-2px)';
            installButton.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.6)';
        };
        installButton.onmouseout = () => {
            installButton.style.transform = 'translateY(0)';
            installButton.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
        };
        document.body.appendChild(installButton);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installButton.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installButton.style.display = 'none';
        });

    </script>
</body>
</html>